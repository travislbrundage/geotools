<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Image Moasic JDBC Design &mdash; GeoTools 13-SNAPSHOT User Guide</title>
    
    <link rel="stylesheet" href="../../../_static/geotools.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '13-SNAPSHOT',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="GeoTools 13-SNAPSHOT User Guide" href="../../../index.html" />
    <link rel="up" title="Image Moasic JDBC" href="index.html" />
    <link rel="next" title="Custom JDBC Access for Images" href="customized.html" />
    <link rel="prev" title="Image Moasic JDBC" href="index.html" /> 
  </head>
  <body role="document">
    <div class="header">
        <div class="wrap">
            <h1 id="logo"><a href="http://geotools.org">GeoTools</a></h1>
            <h1 id="logo_osgeo"><a href="http://osgeo.org">OSGeo</a></h1>
            <ul id="top-nav">
                <li class="first"><a href="http://docs.geotools.org">Documentation</a></li>
                <li><a href="http://sourceforge.net/projects/geotools/files">Downloads</a></li>
                <li><a href="http://docs.codehaus.org/display/GEOTOOLS/Home">Wiki</a></li>
                <li><a href="http://geotools.org/about.html">About</a></li>
                <li><a href="http://geotoolsnews.blogspot.com">Blog</a></li>
            </ul>
            <!--div id="searchbox">
                <form class="search" action="../../../search.html" method="get">
                    <input id="searchbox-query" type="text" name="q" size="25" value="Search &hellip;" tabindex="3" onblur="if(this.value=='') this.value='Search &hellip;';" onfocus="if(this.value=='Search &hellip;') this.value='';" />
                    <input id="searchbox-submit" type="image" value="Search" src="../../../_static/img/search_icon_green.png" />
                    <input type="hidden" name="check_keywords" value="yes" />
                    <input type="hidden" name="area" value="default" />
                </form>
            </div-->
        </div>
    </div>

    <div class="related">
      <ul id="breadcrumbs">
        <li><a href="../../../index.html">GeoTools 13-SNAPSHOT User Guide</a> &raquo;</li>
          <li><a href="../../index.html" >Library</a> &raquo;</li>
          <li><a href="../index.html" >Coverage</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Image Moasic JDBC</a> &raquo;</li>
        <li><a href="#">Image Moasic JDBC Design</a></li>
      </ul>
    </div> 

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Image Moasic JDBC Design</a><ul>
<li><a class="reference internal" href="#outline-of-the-multithreaded-architecture">Outline of the multithreaded architecture</a></li>
<li><a class="reference internal" href="#database-design">Database Design</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Image Moasic JDBC</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="customized.html"
                        title="next chapter">Custom JDBC Access for Images</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../../_sources/library/coverage/jdbc/internal.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="image-moasic-jdbc-design">
<h1>Image Moasic JDBC Design<a class="headerlink" href="#image-moasic-jdbc-design" title="Permalink to this headline">¶</a></h1>
<div class="section" id="outline-of-the-multithreaded-architecture">
<h2>Outline of the multithreaded architecture<a class="headerlink" href="#outline-of-the-multithreaded-architecture" title="Permalink to this headline">¶</a></h2>
<p>The multithreaded architecture is based on synchronized Queue available since SDK 5.0. The following threads will be used:</p>
<ul class="simple">
<li>One ImageComposer thread which reads GridCoverages from the Queue, mosaicing the image and finally rescales the image for the requested dimension.</li>
<li>For each tile, a TileDecoder thread which decodes the tile, crops the tile if necessary und puts the result as GridCoverage in the queue.</li>
<li>The Main thread for controlling this threads</li>
</ul>
<p>The Main threads performs the following steps in chronological order
If the requested CRS ist not equal to the CRS of the tiles, transform the requested CRS</p>
<ol class="arabic simple">
<li>Calculate the best pyramid and query the tiles needed from the database</li>
<li>Create the queue and start the ImageComposer Thread</li>
<li>For each tile fetch the image data and immediately start an ImageDecoder Thread</li>
<li>Wait for all ImageDecoder Threads</li>
<li>Put a predefined End Message in the queue which causes the ImageComposer Thread to finish its work</li>
<li>Wait for the ImageComposer Thread</li>
<li>If the requested CRS ist not equal to the CRS of the tiles, reproject the image</li>
<li>Return the GridCoverage</li>
</ol>
</div>
<div class="section" id="database-design">
<h2>Database Design<a class="headerlink" href="#database-design" title="Permalink to this headline">¶</a></h2>
<p>First, we need a Meta Table for holding Information for each pyramid of the maps. This table has 9 columns as described below</p>
<ul class="simple">
<li>Name (String): The name of the map</li>
<li>SpatialTable (String): The name of the table where to find the georeferencing information</li>
<li>TileTable (String): The name of the table where to find the tile data stored as BLOB.</li>
<li>ResX (Double): The resolution of the x-axis</li>
<li>ResY (Double): The resolution of the y-axis</li>
<li>MinX (Double): The minimum X of the extent</li>
<li>MinY (Double): The minimum Y of the extent</li>
<li>MaxX (Double): The maximum X of the extent</li>
<li>MaxY(Double): The maximum Y of the extent</li>
</ul>
<p><strong>Important</strong></p>
<p>The only fields you have to fill are Name,SpatialTable and TileTable. These three fields together are the primary key. All other fields will be calculated by the plugin. It is not necessary to do calculations. The plugin implements the following mechanism during the first request:</p>
<ol class="arabic simple">
<li>Check if ResX or ResY is null, if true, calculate the values from a random chosen tile from the corresponding tile table.</li>
<li>Check if one of MinX,MinY,MaxX,MaxY is null, if true, calculate the values from the corresponding spatial table.</li>
<li>If something has been calculated, store these values into to db to avoid recalculation at the next restart</li>
</ol>
<p>This approach assures that the probably costly calculation is only executed once, but updating,adding or removing tiles requires you to nullify one of the MinX,MinY,MaxX,MaxY Attributes to force a new extent calculation.</p>
<p><strong>First example</strong></p>
<p>Assume we have a Map called Europe with 2 Pyramids. Since we have 3 levels, we need 3 tile tables and 3 spatial tables. Lets start filling the META table.</p>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="22%" />
<col width="17%" />
<col width="8%" />
<col width="8%" />
<col width="8%" />
<col width="8%" />
<col width="8%" />
<col width="8%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">SpatialTable</th>
<th class="head">TileTable</th>
<th class="head">ResX</th>
<th class="head">ResY</th>
<th class="head">MinX</th>
<th class="head">MinY</th>
<th class="head">MaxX</th>
<th class="head">MaxY</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Europe</td>
<td>EUSPAT0</td>
<td>EUTILE0</td>
<td>.</td>
<td>.</td>
<td>.</td>
<td>.</td>
<td>.</td>
<td>.</td>
</tr>
<tr class="row-odd"><td>Europe</td>
<td>EUSPAT1</td>
<td>EUTILE1</td>
<td>.</td>
<td>.</td>
<td>.</td>
<td>.</td>
<td>.</td>
<td>.</td>
</tr>
<tr class="row-even"><td>Europe</td>
<td>EUSPAT2</td>
<td>EUTILE2</td>
<td>.</td>
<td>.</td>
<td>.</td>
<td>.</td>
<td>.</td>
<td>.</td>
</tr>
</tbody>
</table>
<p>Remember: You do not have to fill the other attributes.</p>
<p>A tile table needs the following attributes:</p>
<ul class="simple">
<li>Location (String) : A unique identifier for the tile</li>
<li>Data (Blob) : The image data (Encoded in a format readable by JAI, e. g. png,jpeg,...)</li>
</ul>
<p>The table EUTILE0 for example ( 0x.... indicates binary data)</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Location</th>
<th class="head">Data</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Tile_1_1</td>
<td>0x10011...</td>
</tr>
<tr class="row-odd"><td>Tile_1_2</td>
<td>0x00011..</td>
</tr>
</tbody>
</table>
<p>A spatial table contains the georeferencing information. Depending on your database installation, there are 2 possibilites.</p>
<ol class="arabic simple">
<li>You have no spatial db extension implies storing the extent in 4 Double fields</li>
<li>Having a spatial extension offers the possiblity to use a geometry column</li>
</ol>
<p>A spatial Table without using a spatial extension needs the following attributes:</p>
<ul class="simple">
<li>Location (String) : A unique identifier used for joining into the tiles table</li>
<li>MinX (Double): min x of the tile extent</li>
<li>MinY (Double): min y of the tile extent</li>
<li>MaxX (Double): max x of the tile extent</li>
<li>MaxY (Double): max y of the tile extent</li>
</ul>
<p>The table EUSPAT0 for example.</p>
<table border="1" class="docutils">
<colgroup>
<col width="35%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Location</th>
<th class="head">MinX</th>
<th class="head">MinY</th>
<th class="head">MaxX</th>
<th class="head">MaxY</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Tile_1_1</td>
<td>10</td>
<td>10</td>
<td>20</td>
<td>20</td>
</tr>
<tr class="row-odd"><td>Tile_1_2</td>
<td>20</td>
<td>10</td>
<td>30</td>
<td>20</td>
</tr>
</tbody>
</table>
<p>A spatial Table using a spatial extension needs the following attributes:</p>
<ul class="simple">
<li>Location (String) : A unique identifier used for joining into the tiles table</li>
<li>Geometry (Geometry): A Multipoligon type provided by your db</li>
</ul>
<p>The table EUTILE0 for example</p>
<table border="1" class="docutils">
<colgroup>
<col width="48%" />
<col width="52%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Location</th>
<th class="head">Geom</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Tile_1_1</td>
<td>0x00111...</td>
</tr>
<tr class="row-odd"><td>Tile_1_2</td>
<td>0x10011...</td>
</tr>
</tbody>
</table>
<p>Reducing the number of tables</p>
<p>Since the number of rows in a spatial table has to be equal to the number of rows in a tile table, there is a one to one relationship. It is no problem to join these tables. Applying this redesign to our samples results in the following table structure:</p>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="22%" />
<col width="17%" />
<col width="8%" />
<col width="8%" />
<col width="8%" />
<col width="8%" />
<col width="8%" />
<col width="8%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">SpatialTable</th>
<th class="head">TileTable</th>
<th class="head">ResX</th>
<th class="head">ResY</th>
<th class="head">MinX</th>
<th class="head">MinY</th>
<th class="head">MaxX</th>
<th class="head">MaxY</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Europe</td>
<td>EU0</td>
<td>EU0</td>
<td>.</td>
<td>.</td>
<td>.</td>
<td>.</td>
<td>.</td>
<td>.</td>
</tr>
<tr class="row-odd"><td>Europe</td>
<td>EU1</td>
<td>EU1</td>
<td>.</td>
<td>.</td>
<td>.</td>
<td>.</td>
<td>.</td>
<td>.</td>
</tr>
<tr class="row-even"><td>Europe</td>
<td>EU2</td>
<td>EU2</td>
<td>.</td>
<td>.</td>
<td>.</td>
<td>.</td>
<td>.</td>
<td>.</td>
</tr>
</tbody>
</table>
<p>The EU0 Table</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="13%" />
<col width="13%" />
<col width="13%" />
<col width="13%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Location</th>
<th class="head">MinX</th>
<th class="head">MinY</th>
<th class="head">MaxX</th>
<th class="head">MaxY</th>
<th class="head">Data</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Tile_1_1</td>
<td>10</td>
<td>10</td>
<td>20</td>
<td>20</td>
<td>0x10011..</td>
</tr>
<tr class="row-odd"><td>Tile_1_2</td>
<td>20</td>
<td>10</td>
<td>30</td>
<td>20</td>
<td>0x00011..</td>
</tr>
</tbody>
</table>
<p>or using a geometry column</p>
<table border="1" class="docutils">
<colgroup>
<col width="30%" />
<col width="33%" />
<col width="36%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Location</th>
<th class="head">Geom</th>
<th class="head">Data</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Tile_1_1</td>
<td>0x00111...</td>
<td>0x10011..</td>
</tr>
<tr class="row-odd"><td>Tile_1_2</td>
<td>0x10011...</td>
<td>0x00011..</td>
</tr>
</tbody>
</table>
<p>Further DB Design Rules</p>
<ul class="simple">
<li>It is possible to add custom columns to your tables</li>
<li>It is possible to create one meta table for all your maps and pyramid levels , or create one meta table for each map containing records for the map and its pyramids, or do any mixture of these two approaches, the only rule is to store a map and its pyramids level together in the same meta table.</li>
<li>All primary key attributes will be handled as JDBC String, the exact DB Type and length depends on your needs.</li>
<li>All numerical fields will be handled as JDBC Double.</li>
<li>Tile image data has to be a BLOB</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <ul id="breadcrumbs">
            <li class="right" style="margin-right: 10px">
              <a href="customized.html" title="Custom JDBC Access for Images"
                 accesskey="N">next</a></li>
            <li class="right" >
              <a href="index.html" title="Image Moasic JDBC"
                 accesskey="P">previous</a> |</li>
        <li><a href="../../../index.html">GeoTools 13-SNAPSHOT User Guide</a> &raquo;</li>
          <li><a href="../../index.html" >Library</a> &raquo;</li>
          <li><a href="../index.html" >Coverage</a> &raquo;</li>
          <li><a href="index.html" >Image Moasic JDBC</a> &raquo;</li>
        <li><a href="#">Image Moasic JDBC Design</a></li>
      </ul>
    </div> 

    <div class="footer" role="contentinfo">
        &copy; Copyright 2014, GeoTools.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3b1.
    </div>
  </body>
</html>