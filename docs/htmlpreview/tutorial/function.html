<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Function Tutorial &mdash; GeoTools 13-SNAPSHOT User Guide</title>
    
    <link rel="stylesheet" href="../_static/geotools.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '13-SNAPSHOT',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="GeoTools 13-SNAPSHOT User Guide" href="../index.html" />
    <link rel="up" title="Tutorials" href="index.html" />
    <link rel="next" title="Process Tutorial" href="process.html" />
    <link rel="prev" title="Factory Tutorial" href="factory.html" /> 
  </head>
  <body role="document">
    <div class="header">
        <div class="wrap">
            <h1 id="logo"><a href="http://geotools.org">GeoTools</a></h1>
            <h1 id="logo_osgeo"><a href="http://osgeo.org">OSGeo</a></h1>
            <ul id="top-nav">
                <li class="first"><a href="http://docs.geotools.org">Documentation</a></li>
                <li><a href="http://sourceforge.net/projects/geotools/files">Downloads</a></li>
                <li><a href="http://docs.codehaus.org/display/GEOTOOLS/Home">Wiki</a></li>
                <li><a href="http://geotools.org/about.html">About</a></li>
                <li><a href="http://geotoolsnews.blogspot.com">Blog</a></li>
            </ul>
            <!--div id="searchbox">
                <form class="search" action="../search.html" method="get">
                    <input id="searchbox-query" type="text" name="q" size="25" value="Search &hellip;" tabindex="3" onblur="if(this.value=='') this.value='Search &hellip;';" onfocus="if(this.value=='Search &hellip;') this.value='';" />
                    <input id="searchbox-submit" type="image" value="Search" src="../_static/img/search_icon_green.png" />
                    <input type="hidden" name="check_keywords" value="yes" />
                    <input type="hidden" name="area" value="default" />
                </form>
            </div-->
        </div>
    </div>

    <div class="related">
      <ul id="breadcrumbs">
        <li><a href="../index.html">GeoTools 13-SNAPSHOT User Guide</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Tutorials</a> &raquo;</li>
        <li><a href="#">Function Tutorial</a></li>
      </ul>
    </div> 

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Function Tutorial</a><ul>
<li><a class="reference internal" href="#snapfunction">SnapFunction</a></li>
<li><a class="reference internal" href="#things-to-try">Things to Try</a></li>
<li><a class="reference internal" href="#function">Function</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="factory.html"
                        title="previous chapter">Factory Tutorial</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="process.html"
                        title="next chapter">Process Tutorial</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/tutorial/function.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="function-tutorial">
<h1>Function Tutorial<a class="headerlink" href="#function-tutorial" title="Permalink to this headline">¶</a></h1>
<p>Adding a Function to GeoTools a very useful introduction to extending the library. This is often
used to generate values when styling that you cannot otherwise accomplish using expressions.</p>
<div class="section" id="snapfunction">
<h2>SnapFunction<a class="headerlink" href="#snapfunction" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Here is a quick implementation of snapping a point to a line:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.geotools.tutorial.function</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.geotools.filter.capability.FunctionNameImpl</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.util.Converters</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.filter.capability.FunctionName</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.filter.expression.Expression</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.filter.expression.ExpressionVisitor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.filter.expression.Function</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.filter.expression.Literal</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.vividsolutions.jts.geom.Coordinate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.vividsolutions.jts.geom.Geometry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.vividsolutions.jts.geom.Point</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.vividsolutions.jts.linearref.LinearLocation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.vividsolutions.jts.linearref.LocationIndexedLine</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Quick function that illustrates snapping to a line.</span>
<span class="cm"> * </span>
<span class="cm"> * @author jody</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SnapFunction</span> <span class="kd">implements</span> <span class="n">Function</span> <span class="o">{</span>

    <span class="kd">static</span> <span class="n">FunctionName</span> <span class="n">NAME</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FunctionNameImpl</span><span class="o">(</span><span class="s">&quot;snap&quot;</span><span class="o">,</span> <span class="n">Point</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">FunctionNameImpl</span><span class="o">.</span><span class="na">parameter</span><span class="o">(</span><span class="s">&quot;point&quot;</span><span class="o">,</span><span class="n">Point</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
            <span class="n">FunctionNameImpl</span><span class="o">.</span><span class="na">parameter</span><span class="o">(</span><span class="s">&quot;line&quot;</span><span class="o">,</span><span class="n">Geometry</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Expression</span><span class="o">&gt;</span> <span class="n">parameters</span><span class="o">;</span>
    
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Literal</span> <span class="n">fallback</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nf">SnapFunction</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Expression</span><span class="o">&gt;</span> <span class="n">parameters</span><span class="o">,</span> <span class="n">Literal</span> <span class="n">fallback</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">parameters</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">(</span><span class="s">&quot;parameters required&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">parameters</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span>
                    <span class="s">&quot;snap( point, line) requires two parameters only&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">parameters</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">fallback</span> <span class="o">=</span> <span class="n">fallback</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">evaluate</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">evaluate</span><span class="o">(</span><span class="n">object</span><span class="o">,</span> <span class="n">Point</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">evaluate</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Expression</span> <span class="n">pointExpression</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="n">Point</span> <span class="n">point</span> <span class="o">=</span> <span class="n">pointExpression</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="n">object</span><span class="o">,</span> <span class="n">Point</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    
        <span class="n">Expression</span> <span class="n">lineExpression</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">Geometry</span> <span class="n">line</span> <span class="o">=</span> <span class="n">lineExpression</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="n">object</span><span class="o">,</span> <span class="n">Geometry</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    
        <span class="n">LocationIndexedLine</span> <span class="n">index</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LocationIndexedLine</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
    
        <span class="n">LinearLocation</span> <span class="n">location</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="na">project</span><span class="o">(</span><span class="n">point</span><span class="o">.</span><span class="na">getCoordinate</span><span class="o">());</span>
    
        <span class="n">Coordinate</span> <span class="n">snap</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="na">extractPoint</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>
    
        <span class="n">Point</span> <span class="n">pt</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="na">getFactory</span><span class="o">().</span><span class="na">createPoint</span><span class="o">(</span><span class="n">snap</span><span class="o">);</span>
    
        <span class="k">return</span> <span class="n">Converters</span><span class="o">.</span><span class="na">convert</span><span class="o">(</span><span class="n">pt</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span> <span class="c1">// convert to requested format</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">accept</span><span class="o">(</span><span class="n">ExpressionVisitor</span> <span class="n">visitor</span><span class="o">,</span> <span class="n">Object</span> <span class="n">extraData</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="na">visit</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">extraData</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">NAME</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="n">FunctionName</span> <span class="nf">getFunctionName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">NAME</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Expression</span><span class="o">&gt;</span> <span class="nf">getParameters</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">parameters</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="n">Literal</span> <span class="nf">getFallbackValue</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">fallback</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">The mechanics of using a LocationIndexLine are covered in <a class="reference internal" href="../library/jts/snap.html"><em>Snap a Point to a Line</em></a>
if you are interested.</p>
</li>
<li><p class="first">One thing to notice is the definition of FunctionName used to describe valid parameters to
user of our new function.</p>
<p>By convention we define this as a static final SnapFunction.NAME, this is however only a
convention (which will help in implementing the next section).</p>
</li>
<li><p class="first">Create ExampleFunctionFactory implementing FunctionFactory</p>
</li>
<li><p class="first">Fill in the information as shown:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.geotools.tutorial.function</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.geotools.feature.NameImpl</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.filter.FunctionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.feature.type.Name</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.filter.capability.FunctionName</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.filter.expression.Expression</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.filter.expression.Function</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.filter.expression.Literal</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExampleFunctionFactory</span> <span class="kd">implements</span> <span class="n">FunctionFactory</span> <span class="o">{</span>    
    
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">FunctionName</span><span class="o">&gt;</span> <span class="nf">getFunctionNames</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">FunctionName</span><span class="o">&gt;</span> <span class="n">functionList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">FunctionName</span><span class="o">&gt;();</span>
        <span class="n">functionList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">SnapFunction</span><span class="o">.</span><span class="na">NAME</span><span class="o">);</span>        
        <span class="k">return</span> <span class="n">Collections</span><span class="o">.</span><span class="na">unmodifiableList</span><span class="o">(</span> <span class="n">functionList</span> <span class="o">);</span>
    <span class="o">}</span>    
    <span class="kd">public</span> <span class="n">Function</span> <span class="nf">function</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Expression</span><span class="o">&gt;</span> <span class="n">args</span><span class="o">,</span> <span class="n">Literal</span> <span class="n">fallback</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">function</span><span class="o">(</span><span class="k">new</span> <span class="n">NameImpl</span><span class="o">(</span><span class="n">name</span><span class="o">),</span> <span class="n">args</span><span class="o">,</span> <span class="n">fallback</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Function</span> <span class="nf">function</span><span class="o">(</span><span class="n">Name</span> <span class="n">name</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Expression</span><span class="o">&gt;</span> <span class="n">args</span><span class="o">,</span> <span class="n">Literal</span> <span class="n">fallback</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span> <span class="n">SnapFunction</span><span class="o">.</span><span class="na">NAME</span><span class="o">.</span><span class="na">getFunctionName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">name</span><span class="o">)){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">SnapFunction</span><span class="o">(</span> <span class="n">args</span><span class="o">,</span> <span class="n">fallback</span> <span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// we do not implement that function</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">We make reference to the static final SnapFunction.NAME.</p>
<p>While we mentioned this as only a convention, you are free to create a
new new FunctionNameImpl(&#8220;snap&#8221;, &#8220;point&#8221;, &#8220;line&#8221;) as part of the getFunctionNames() method.
This has the advantage of avoiding loading SnapFunction until a user requests it by name.</p>
</li>
<li><p class="first">We can now register our factory.</p>
<p>Create the file:</p>
<ul class="simple">
<li>META_INF/services/org.geotools.filter.FunctionFactory</li>
</ul>
</li>
<li><p class="first">Fill in the following contents (one implementation class per line):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">org</span><span class="o">.</span><span class="n">geotools</span><span class="o">.</span><span class="n">tutorial</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">ExampleFunctionFactory</span>
</pre></div>
</div>
</li>
<li><p class="first">That is it SnapFunction is now published!</p>
<p>You can use the &#8220;snap&#8221; function from your SLD documents; or in normal java programs.</p>
</li>
</ol>
</div>
<div class="section" id="things-to-try">
<h2>Things to Try<a class="headerlink" href="#things-to-try" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">Create a quick test case to show that the above function is available using:</p>
<div class="highlight-python"><div class="highlight"><pre>FunctionFactory ff = CommonFactoryFinder.getFactoryFinder();
Expression expr = ff.function( &quot;snap&quot;, ff.property(&quot;the_geom&quot;), ff.literal( lines ) );
</pre></div>
</div>
</li>
<li><p class="first">The function should be very slow as written (when called to snap thousands of points).</p>
<p>Have a check if you can detect the use of a literal MultiLineStinrg; and cache your
LocationIndexedLine between calls to the function. A lot of GeoTools functions have been
optimised in this fashion.</p>
</li>
<li><p class="first">A fair bit of the code above is &#8220;boilerplate&#8221; and could be simplified with an appropriate
&#8220;AbstractFunction&#8221; class.</p>
<p>GeoTools does provide a couple Abstract classes you can extend when defining your own functions.
Have a look <strong>FunctionImpl</strong> and see if you find it easier then just starting from scratch.</p>
</li>
<li><p class="first">Functions are used to process their parameters and produce an answer:</p>
<div class="highlight-python"><div class="highlight"><pre>public Object evaluate(Object feature) {
    Expression geomExpression = parameters.get(0);
    Geometry geom = geomExpression.evaulate( feature, Geometry.class );

    return geom.centroid();
}
</pre></div>
</div>
<p>When a function is used as part of a Style users often want to calculate a value based
on the attributes of the Feature being drawn.  The Expression PropertyName is used in this
fashion to extract values out of a Feature and pass them into the function for evaluation</p>
<p><strong>IMPORTANT</strong>: When using your function with a Style we try and be efficient. If the style
calls your function without any reference to PropertyName it will only be called once.
The assumption is that the function will produce the same value each time it is called, and
thus will produce the same value for all features. By only calling the function once (and
remembering the result) the rendering engine is able to perform much faster.</p>
<p>If this is not the functionality you are after please implement <strong>VolatileFunction</strong>:</p>
<div class="highlight-python"><div class="highlight"><pre>public class MagicFunction extends FunctionExpressionImpl implements VolatileFunction {
    Random random;
    public MagicFunction() {
        super(&quot;magic&quot;);
        random = new Random();
    }
    public int getArgCount() {
        return 0; // no arguments!
    }
    public Object evaluate(Object feature) {
        float r = rand.nextFloat();
        float g = rand.nextFloat();
        float b = rand.nextFloat();

        Color color = new Color(r, g, b);

        return color;
    }
}
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="function">
<h2>Function<a class="headerlink" href="#function" title="Permalink to this headline">¶</a></h2>
<p>Normally we have a little background information on the concepts covered; in this case there is an
article on how GeoTools uses Factories; and the steps to consider when creating your own
factory system for others to use.</p>
<ul class="simple">
<li><a class="reference internal" href="factory.html"><em>Factory Tutorial</em></a></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <ul id="breadcrumbs">
            <li class="right" style="margin-right: 10px">
              <a href="process.html" title="Process Tutorial"
                 accesskey="N">next</a></li>
            <li class="right" >
              <a href="factory.html" title="Factory Tutorial"
                 accesskey="P">previous</a> |</li>
        <li><a href="../index.html">GeoTools 13-SNAPSHOT User Guide</a> &raquo;</li>
          <li><a href="index.html" >Tutorials</a> &raquo;</li>
        <li><a href="#">Function Tutorial</a></li>
      </ul>
    </div> 

    <div class="footer" role="contentinfo">
        &copy; Copyright 2014, GeoTools.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3b1.
    </div>
  </body>
</html>