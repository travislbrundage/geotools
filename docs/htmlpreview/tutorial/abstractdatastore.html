<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>AbstractDataStore Tutorial &mdash; GeoTools 13-SNAPSHOT User Guide</title>
    
    <link rel="stylesheet" href="../_static/geotools.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '13-SNAPSHOT',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="GeoTools 13-SNAPSHOT User Guide" href="../index.html" />
    <link rel="up" title="Tutorials" href="index.html" />
    <link rel="next" title="ContentDataStore Tutorial" href="datastore/index.html" />
    <link rel="prev" title="Process Tutorial" href="process.html" /> 
  </head>
  <body role="document">
    <div class="header">
        <div class="wrap">
            <h1 id="logo"><a href="http://geotools.org">GeoTools</a></h1>
            <h1 id="logo_osgeo"><a href="http://osgeo.org">OSGeo</a></h1>
            <ul id="top-nav">
                <li class="first"><a href="http://docs.geotools.org">Documentation</a></li>
                <li><a href="http://sourceforge.net/projects/geotools/files">Downloads</a></li>
                <li><a href="http://docs.codehaus.org/display/GEOTOOLS/Home">Wiki</a></li>
                <li><a href="http://geotools.org/about.html">About</a></li>
                <li><a href="http://geotoolsnews.blogspot.com">Blog</a></li>
            </ul>
            <!--div id="searchbox">
                <form class="search" action="../search.html" method="get">
                    <input id="searchbox-query" type="text" name="q" size="25" value="Search &hellip;" tabindex="3" onblur="if(this.value=='') this.value='Search &hellip;';" onfocus="if(this.value=='Search &hellip;') this.value='';" />
                    <input id="searchbox-submit" type="image" value="Search" src="../_static/img/search_icon_green.png" />
                    <input type="hidden" name="check_keywords" value="yes" />
                    <input type="hidden" name="area" value="default" />
                </form>
            </div-->
        </div>
    </div>

    <div class="related">
      <ul id="breadcrumbs">
        <li><a href="../index.html">GeoTools 13-SNAPSHOT User Guide</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Tutorials</a> &raquo;</li>
        <li><a href="#">AbstractDataStore Tutorial</a></li>
      </ul>
    </div> 

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">AbstractDataStore Tutorial</a><ul>
<li><a class="reference internal" href="#part-1-introducing-propertydatastore">Part 1 - Introducing PropertyDataStore</a></li>
<li><a class="reference internal" href="#part-2-creating-propertydatastore">Part 2 - Creating PropertyDataStore</a><ul>
<li><a class="reference internal" href="#propertydatastore">PropertyDataStore</a></li>
<li><a class="reference internal" href="#propertyfeaturereader">PropertyFeatureReader</a></li>
<li><a class="reference internal" href="#propertyattributereader">PropertyAttributeReader</a></li>
<li><a class="reference internal" href="#datastorefactory">DataStoreFactory</a></li>
</ul>
</li>
<li><a class="reference internal" href="#part-3-using-property-datastore-to-read-files">Part 3 - Using Property DataStore to Read Files</a><ul>
<li><a class="reference internal" href="#datastore">DataStore</a></li>
<li><a class="reference internal" href="#featuresource">FeatureSource</a></li>
<li><a class="reference internal" href="#featurecollection">FeatureCollection</a></li>
</ul>
</li>
<li><a class="reference internal" href="#part-4-making-property-datastore-writable">Part 4 - Making Property DataStore Writable</a><ul>
<li><a class="reference internal" href="#propertydatastorefactory">PropertyDataStoreFactory</a></li>
<li><a class="reference internal" href="#id1">PropertyDataStore</a></li>
<li><a class="reference internal" href="#propertyfeaturewriter">PropertyFeatureWriter</a></li>
<li><a class="reference internal" href="#propertyattributewriter">PropertyAttributeWriter</a></li>
</ul>
</li>
<li><a class="reference internal" href="#part-5-using-propertydatastore-to-write-files">Part 5 - Using PropertyDataStore to Write Files</a><ul>
<li><a class="reference internal" href="#id2">FeatureSource</a><ul>
<li><a class="reference internal" href="#featurestore">FeatureStore</a></li>
<li><a class="reference internal" href="#featurelocking">FeatureLocking</a></li>
</ul>
</li>
<li><a class="reference internal" href="#featurewriter">FeatureWriter</a><ul>
<li><a class="reference internal" href="#featurewriter-filter">FeatureWriter Filter</a></li>
<li><a class="reference internal" href="#id3">FeatureWriter</a></li>
<li><a class="reference internal" href="#featurewriter-append">FeatureWriter Append</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#part-6-optimisation-of-propertydatastore">Part 6 - Optimisation of PropertyDataStore</a><ul>
<li><a class="reference internal" href="#low-level-optimisation">Low-Level Optimisation</a><ul>
<li><a class="reference internal" href="#external-transaction-support">External Transaction Support</a></li>
<li><a class="reference internal" href="#external-locking-support">External Locking Support</a></li>
<li><a class="reference internal" href="#single-use-feature-writers">Single Use Feature Writers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#high-level-optimisation">High-Level Optimisation</a><ul>
<li><a class="reference internal" href="#datastore-optimisation">DataStore Optimisation</a></li>
<li><a class="reference internal" href="#featurestore-optimisation">FeatureStore Optimisation</a></li>
<li><a class="reference internal" href="#cacheing-and-featurelistener">Cacheing and FeatureListener</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id4">PropertyDataStore</a></li>
<li><a class="reference internal" href="#propertyfeaturesource">PropertyFeatureSource</a></li>
<li><a class="reference internal" href="#propertyfeaturestore">PropertyFeatureStore</a></li>
</ul>
</li>
<li><a class="reference internal" href="#part-7-quality-assurance">Part 7 - Quality Assurance</a><ul>
<li><a class="reference internal" href="#multiline">Multiline</a></li>
<li><a class="reference internal" href="#info">Info</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="process.html"
                        title="previous chapter">Process Tutorial</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="datastore/index.html"
                        title="next chapter">ContentDataStore Tutorial</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/tutorial/abstractdatastore.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="abstractdatastore-tutorial">
<h1>AbstractDataStore Tutorial<a class="headerlink" href="#abstractdatastore-tutorial" title="Permalink to this headline">¶</a></h1>
<div class="sidebar">
<p class="first sidebar-title">gt-property plugin</p>
<p>This tutorial takes you through the steps of creating <strong>PropertyDataStore</strong> originally this
format was only used by this tutorial to show how the DataStore API worked.</p>
<p class="last">Over time the property file format has become widely used due to its simplicity; as a result
<strong>PropertyDataStore</strong> is now considered a supported module in it&#8217;s own right.</p>
</div>
<p>The GeoTools project strives to support as many geographical data formats as possible because
getting data into the GeoTools API allows access to a vast suite of tools. In order to transform
a data format into the GeoTools2 feature representation one must write an implementation of
the <strong>DataStore</strong> interface.</p>
<p>Once a DataStore implementation is written, any information written in that format becomes available
not only for GeoTools users, but also for projects built on top of GeoTools such as GeoServer
and uDig.</p>
<p>Writing a new DataStore for GeoTools is one of the best ways to get involved in the project, as
writing it will make clear many of the core concepts of the API. Finally, the modular nature of
GeoTools allows new DataStores to quickly become part of the next release, so that new formats
are can be distributed to to all GeoTools users.</p>
<p>References:</p>
<ul class="simple">
<li><a class="reference internal" href="../library/data/property.html"><em>Property Plugin</em></a></li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>AbstractDataStore is the original GeoTools 2.0 class; since that time we have learned
a number of tricks and have a much easier starting point for you in the form of
<strong>ContentDataStore</strong>.</p>
<p class="last">While <strong>ContentDataStore</strong> is a lot less work to use; it is not yet as fully featured
as AbstractDataStore. You may wish to try both tutorials before deciding on a course
of action.</p>
</div>
<div class="section" id="part-1-introducing-propertydatastore">
<h2>Part 1 - Introducing PropertyDataStore<a class="headerlink" href="#part-1-introducing-propertydatastore" title="Permalink to this headline">¶</a></h2>
<p>In this tutorial we will build a property file based DataStore, and in the process explore several
aspects of DataStores and their implementation.</p>
<p>We will be working with content in the following format:</p>
<div class="highlight-python"><div class="highlight"><pre>_=id:Integer,geom:Geometry,name:String
rd1=1|wkt|road one
rd2=2|wkt|road two
</pre></div>
</div>
<p>These examples use the file <a class="reference download internal" href="../_downloads/example.properties"><code class="xref download docutils literal"><span class="pre">example.properties</span></code></a>.</p>
<div class="highlight-python"><div class="highlight"><pre>_=id:Integer,name:String,geom:Point
fid1=1|jody garnett|POINT(0 0)
fid2=2|brent|POINT(10 10)
fid3=3|dave|POINT(20 20)
fid4=4|justin deolivera|POINT(30 30)
</pre></div>
</div>
<p>If you want to follow along with this tutorial, start a new Java project in your favourite IDE,
and ensure that GeoTools is on your CLASSPATH.</p>
<p>The DataStore we will be writing (called &#8220;PropertyDataStore&#8221;) takes a directory full of .properties
files and allows reading and writing to them:</p>
<ul>
<li><p class="first">Each of the .properties files represents a &#8220;data set&#8221; - called a FeatureType by GeoTools</p>
</li>
<li><p class="first">Each of these &#8220;data sets&#8221; contains a set of Features.</p>
<p>You can think of each of these .properties files as a table in a database
or a shapefile (with its corresponding .dbf attributes file).</p>
</li>
</ul>
<p>Each of the .properties is very much like a PSV (Pipe Separated Variety) database file. The first
line defines the names (and types) of the columns, and the rest of the lines contain the data;
each element (&#8220;column&#8221;) separated by a &#8216;|&#8217; (&#8220;pipe&#8221;) character.</p>
<p>Consider this file (&#8220;roads.property&#8221;):</p>
<div class="highlight-python"><div class="highlight"><pre>_=id:Integer,geom:Geometry,name:String
rd1=1|LINESTRING(0 0,10 10)|road one
rd2=2|LINESTRING(20 20,30 30)|road two
</pre></div>
</div>
<p>For the moment, ignore everything to the left of an &#8220;=&#8221;. The first line indicates that there are
3 columns. The first one is called &#8220;id&#8221; (of type Integer), the next one called &#8220;geom&#8221; (of type
Geometry), and one called &#8220;name&#8221; (of type String).</p>
<p>The first row has id &#8220;1&#8221;, geom &#8220;LINESTRING(0 0,10 10)&#8221;, and name &#8220;road one&#8221;.</p>
<p>Now, lets consider the information to the left of the &#8220;=&#8221; sign. The first line begins with
&#8220;_=&#8221;. This indicates this is a special line - it defines the column names and types. The rest of
the lines start with a unique identifier (&#8220;rd1&#8221;, and &#8220;rd2&#8221;) - these will be the FIDs (Feature IDs)
for each row (ie. a single Feature). The FID is completely different from the id attribute - every
.properties file will have a FIDs, most will not have an &#8220;id&#8221; column/attribute.</p>
<p>So, the last data row (a Feature) has FID &#8220;rd2&#8221;, id &#8220;2&#8221;, geom &#8220;LINESTRING(20 20,30 30)&#8221;, and
name &#8220;road two&#8221;.</p>
<p><strong>Definitions</strong></p>
<p>As you walk through this tutorial, please remember the following:</p>
<dl class="docutils">
<dt>FID</dt>
<dd>Uniquely defines a Feature (row in the .properties file).</dd>
<dt>FeatureType</dt>
<dd>Same as the name of the .properties file (ie. &#8220;roads&#8221; for roads.properties)</dd>
<dt>DataStore</dt>
<dd>Access all the FeatureTypes (.properties files) in a directory</dd>
<dt>Schema</dt>
<dd>Names of the columns and their types</dd>
</dl>
</div>
<div class="section" id="part-2-creating-propertydatastore">
<h2>Part 2 - Creating PropertyDataStore<a class="headerlink" href="#part-2-creating-propertydatastore" title="Permalink to this headline">¶</a></h2>
<p>Okay with the background out of the way we can get to work.</p>
<div class="section" id="propertydatastore">
<h3>PropertyDataStore<a class="headerlink" href="#propertydatastore" title="Permalink to this headline">¶</a></h3>
<p>The first step is to create a basic DataStore that only supports feature extraction. We will read data from a properties file into the GeoTools2 feature model.</p>
<p>To implement a DataStore we will subclass AbstractDataStore and implement three abstract methods:</p>
<ul class="simple">
<li>DataStore.getTypeNames()</li>
<li>DataStore.getSchema( typeName )</li>
<li>DataStore.getFeatureReader( typeName )</li>
</ul>
<ol class="arabic">
<li><p class="first">To begin create the file PropertyDataStore as follows:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.geotools.data.property</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.BufferedReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FilenameFilter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.geotools.data.AbstractDataStore</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.data.DataSourceException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.data.DataUtilities</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.data.FeatureReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.feature.SchemaException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.feature.simple.SimpleFeature</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.feature.simple.SimpleFeatureType</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PropertyDataStore</span> <span class="kd">extends</span> <span class="n">AbstractDataStore</span> <span class="o">{</span>
    <span class="kd">protected</span> <span class="n">File</span> <span class="n">directory</span><span class="o">;</span>

    <span class="kd">protected</span> <span class="n">String</span> <span class="n">namespaceURI</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">PropertyDataStore</span><span class="o">(</span><span class="n">File</span> <span class="n">dir</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="n">dir</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">PropertyDataStore</span><span class="o">(</span><span class="n">File</span> <span class="n">dir</span><span class="o">,</span> <span class="n">String</span> <span class="n">namespaceURI</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">dir</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="n">dir</span> <span class="o">+</span> <span class="s">&quot; is not a directory&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">namespaceURI</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">namespaceURI</span> <span class="o">=</span> <span class="n">dir</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">dir</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">namespaceURI</span> <span class="o">=</span> <span class="n">namespaceURI</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
<p>Our constructor is going to hold on to two fields:</p>
<ul class="simple">
<li>file: the file we are reading</li>
<li>namespaceURI: namespace (used to tell different property datastore&#8217;s apart)</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As we bring in each snippet of code you will need to import the mentioned
classes. In the Eclipse IDE <strong>Control-Shift-o</strong> will organise imports
and as a side effect import anything you are missing.</p>
</div>
</li>
<li><p class="first">PropertyDataStore.getTypeNames()</p>
<p>A DataStore may provide access to several different types of information. The method
getTypeNames provides a list of the available types.</p>
<p>For our purposes this list will be the name of the property files in a directory.</p>
<p>Add the following implementation for getTypeNames():</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="cm">/**</span>
<span class="cm">     * Gets the names of feature types available in this {@code DataStore}.</span>
<span class="cm">     * </span>
<span class="cm">     * @return array of type name&#39;s published by this datastore</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">String</span><span class="o">[]</span> <span class="nf">getTypeNames</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">list</span><span class="o">[]</span> <span class="o">=</span> <span class="n">directory</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="k">new</span> <span class="n">FilenameFilter</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">accept</span><span class="o">(</span><span class="n">File</span> <span class="n">dir</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&quot;.properties&quot;</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">list</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">list</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">list</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">list</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="sc">&#39;.&#39;</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">list</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">PropertyDataStore.getSchema( typeName )</p>
<p>Schema information is provided by the FeatureType class. This method provides access to a
FeatureType referenced by a type name.</p>
<p>To implement this method we will need to do two things, read a line from a properties file,
and interpret the line as a FeatureType.</p>
<p>The DataUtilities class provides an assortment of helper functions. In this method we will
use DataUtilities.createType( name, spec ).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>DataUtilities is a class especially designed for this tutorial.</p>
<p class="last">Those experienced with GeoTools may find these humble beginnings amusing
given how widely used DataUtilities is today.</p>
</div>
<p>Add getSchema( typeName ):</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="cm">/**</span>
<span class="cm">     * Creates a Schema (FeatureType) from the first line of the .properties</span>
<span class="cm">     * file</span>
<span class="cm">     * </span>
<span class="cm">     * @param typeName TypeName indicating the property file used</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">SimpleFeatureType</span> <span class="nf">getSchema</span><span class="o">(</span><span class="n">String</span> <span class="n">typeName</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">typeSpec</span> <span class="o">=</span> <span class="n">property</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="s">&quot;_&quot;</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">namespace</span> <span class="o">=</span> <span class="n">directory</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">DataUtilities</span><span class="o">.</span><span class="na">createType</span><span class="o">(</span><span class="n">namespace</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">typeName</span><span class="o">,</span>
                    <span class="n">typeSpec</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SchemaException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">DataSourceException</span><span class="o">(</span><span class="n">typeName</span> <span class="o">+</span> <span class="s">&quot; schema not available&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></div>
</div>
<p>Add property( typeName, key ):</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="cm">/**</span>
<span class="cm">     * Opens the file given in typeName and reads through looking for a line</span>
<span class="cm">     * that begins with key and then &quot;=&quot;.</span>
<span class="cm">     * </span>
<span class="cm">     * @param typeName indicates file to open</span>
<span class="cm">     * @param key indicates the line to read</span>
<span class="cm">     * @return the key&#39;s values (everything to the right of the &#39;=&#39;</span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="nf">property</span><span class="o">(</span><span class="n">String</span> <span class="n">typeName</span><span class="o">,</span> <span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">directory</span><span class="o">,</span> <span class="n">typeName</span> <span class="o">+</span> <span class="s">&quot;.properties&quot;</span><span class="o">);</span>
        <span class="n">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">FileReader</span><span class="o">(</span><span class="n">file</span><span class="o">));</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span> <span class="n">line</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">line</span> <span class="o">=</span> <span class="n">reader</span>
                    <span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">line</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="n">key</span> <span class="o">+</span> <span class="s">&quot;=&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">reader</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">PropertyDataStore.getFeatureReader( typeName )</p>
<p>FeatureReader is the low-level API provided by DataStore for accessing Feature content.</p>
<p>The method AbstractDataStore.getFeatureReader( typeName ) is required by the superclass
AbstractDataStore and is not part of the public DataStore API accessed by user. We will cover
how this method is used at the end of this tutorial where we discuss optimisation.</p>
<p>Add PropertyDataStore.getFeatureReader( typeName ):</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="cm">/**</span>
<span class="cm">     * Implements access to the &quot;raw&quot; FeatureReader, this method is called</span>
<span class="cm">     * internally by AbstractDataStore.</span>
<span class="cm">     * </span>
<span class="cm">     * @param typeName TypeName indicating property file to read</span>
<span class="cm">     * @return FeatureReader providing access to contents of file</span>
<span class="cm">     */</span>
    <span class="kd">protected</span> <span class="n">FeatureReader</span><span class="o">&lt;</span><span class="n">SimpleFeatureType</span><span class="o">,</span> <span class="n">SimpleFeature</span><span class="o">&gt;</span> <span class="nf">getFeatureReader</span><span class="o">(</span>
            <span class="n">String</span> <span class="n">typeName</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">PropertyFeatureReader</span><span class="o">(</span><span class="n">directory</span><span class="o">,</span> <span class="n">typeName</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Next up we will be implementing PropertyFeatureReader mentioned above.</p>
<p>If you are in Eclipse you can:</p>
<ol class="last arabic simple">
<li>Hold down <strong>Control-Shift-1</strong> to bring up a number of &#8220;Quickfixes&#8221;</li>
<li>Select <strong>Create class &#8216;PropertyFeatureReader&#8217;</strong> from the list</li>
<li>The Create Class wizard is brought up with all the correct blanks filled in</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="section" id="propertyfeaturereader">
<h3>PropertyFeatureReader<a class="headerlink" href="#propertyfeaturereader" title="Permalink to this headline">¶</a></h3>
<p>FeatureReader is similar to the Java Iterator construct, with the addition of
FeatureType (and IOExceptions).</p>
<p>FeatureReader interface:</p>
<ul class="simple">
<li>FeatureReader.getFeatureType()</li>
<li>FeatureReader.next()</li>
<li>FeatureReader.hasNext()</li>
<li>FeatureReader.close()</li>
</ul>
<p>To implement our FeatureReader, we will need to do several things: open a File and read through it
line by line, parsing Features as we go.</p>
<ol class="arabic">
<li><p class="first">PropertyFeatureReader</p>
<p>Create the file PropertyFeatureReader as follows:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.geotools.data.property</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.NoSuchElementException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.logging.Logger</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.geotools.data.FeatureReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.feature.simple.SimpleFeatureBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.util.logging.Logging</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.feature.IllegalAttributeException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.feature.simple.SimpleFeature</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.feature.simple.SimpleFeatureType</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * FeatureReader access to the contents of a PropertyFile.</span>
<span class="cm"> * </span>
<span class="cm"> * @author Jody Garnett</span>
<span class="cm"> * @version 8.0.0</span>
<span class="cm"> * @since 2.0.0</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PropertyFeatureReader</span> <span class="kd">implements</span>
        <span class="n">FeatureReader</span><span class="o">&lt;</span><span class="n">SimpleFeatureType</span><span class="o">,</span> <span class="n">SimpleFeature</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">Logging</span>
            <span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="s">&quot;org.geotools.data.property&quot;</span><span class="o">);</span>

    <span class="n">PropertyAttributeReader</span> <span class="n">reader</span><span class="o">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Creates a new PropertyFeatureReader object.</span>
<span class="cm">     * </span>
<span class="cm">     * @param directory Directory containing property file</span>
<span class="cm">     * @param typeName TypeName indicating file to read</span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="nf">PropertyFeatureReader</span><span class="o">(</span><span class="n">File</span> <span class="n">directory</span><span class="o">,</span> <span class="n">String</span> <span class="n">typeName</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">directory</span><span class="o">,</span> <span class="n">typeName</span> <span class="o">+</span> <span class="s">&quot;.properties&quot;</span><span class="o">);</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PropertyAttributeReader</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Access to schema description.</span>
<span class="cm">     * </span>
<span class="cm">     * @return SimpleFeatureType describing attribtues</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">SimpleFeatureType</span> <span class="nf">getFeatureType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">reader</span><span class="o">.</span><span class="na">type</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Access the next feature (if available).</span>
<span class="cm">     * </span>
<span class="cm">     * @return SimpleFeature read from property file</span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     * @throws IllegalAttributeException</span>
<span class="cm">     * @throws NoSuchElementException</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">SimpleFeature</span> <span class="nf">next</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">IllegalAttributeException</span><span class="o">,</span>
            <span class="n">NoSuchElementException</span> <span class="o">{</span>
        <span class="n">reader</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>

        <span class="n">SimpleFeatureType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">type</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">fid</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">getFeatureID</span><span class="o">();</span>
        <span class="n">Object</span><span class="o">[]</span> <span class="n">values</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="n">reader</span><span class="o">.</span><span class="na">getAttributeCount</span><span class="o">()];</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reader</span><span class="o">.</span><span class="na">getAttributeCount</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">values</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">values</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">SimpleFeatureBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">values</span><span class="o">,</span> <span class="n">fid</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Check if additional contents are available.</span>
<span class="cm">     * </span>
<span class="cm">     * @return &lt;code&gt;true&lt;/code&gt; if additional contents are available</span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">reader</span><span class="o">.</span><span class="na">hasNext</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Close the FeatureReader when not in use.</span>
<span class="cm">     * </span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">reader</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="na">warning</span><span class="o">(</span><span class="s">&quot;Stream seems to be already closed.&quot;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">reader</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The helper class PropertyAttributeReader will be used to accomplish the bulk of this work.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Note the use of the GeoTools Logging system. GeoTools provides a wrapper around
the usual suspects (Java Logging, Log4J, etc...) allowing users to configure
the library to work with the logging system employed by their application.</p>
<p class="last">We are just that cool :-)</p>
</div>
</li>
</ol>
</div>
<div class="section" id="propertyattributereader">
<h3>PropertyAttributeReader<a class="headerlink" href="#propertyattributereader" title="Permalink to this headline">¶</a></h3>
<p>The AttributeReader interface is used to provide access to individual attributes from a
storage medium. It is hoped that high level operations (such as Joining) could make
use of this capability.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If it makes sense for your data format you could just do all the work in your FeaureReader.</p>
<p class="last">Why would you break things up into AttributeReaders? If you had several files you were merging
together (such as is the case for Shapefile which has shp, dbf, and shx files).</p>
</div>
<p>AttributeReader interface:</p>
<ul class="simple">
<li>AttributeReader.getAttributeCount</li>
<li>AttributeReader.hasNext( index )</li>
<li>AttributeReader.next()</li>
<li>AttributeReader.read(int)</li>
<li>AttributeReader.getAttributeType( index )</li>
<li>AttributeReader.close()</li>
</ul>
<p>Because this class actually does some work, we are going to include a few more comments
in the code to keep our heads on straight.</p>
<ol class="arabic">
<li><p class="first">Create the file PropertyAttributeReader as follows:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.geotools.data.property</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.BufferedReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.NoSuchElementException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.geotools.data.AttributeReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.data.DataSourceException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.data.DataUtilities</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.feature.SchemaException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.util.Converters</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.feature.simple.SimpleFeatureType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.feature.type.AttributeDescriptor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.feature.type.GeometryType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.referencing.crs.CoordinateReferenceSystem</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.vividsolutions.jts.geom.Geometry</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Simple AttributeReader that works against Java properties files.</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * This AttributeReader is part of the GeoTools AbstractDataStore tutorial, and</span>
<span class="cm"> * should be considered a Toy.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * The content of this file should start with a the property &quot;_&quot; with the value</span>
<span class="cm"> * being the typeSpec describing the featureType. Thereafter each line will</span>
<span class="cm"> * should have a FeatureID as the property and the attribtues as the value</span>
<span class="cm"> * separated by | characters.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> * </span>
<span class="cm"> * &lt;pre&gt;</span>
<span class="cm"> * &lt;code&gt;</span>
<span class="cm"> * _=id:Integer|name:String|geom:Geometry</span>
<span class="cm"> * fid1=1|Jody|&lt;i&gt;well known text&lt;/i&gt;</span>
<span class="cm"> * fid2=2|Brent|&lt;i&gt;well known text&lt;/i&gt;</span>
<span class="cm"> * fid3=3|Dave|&lt;i&gt;well known text&lt;/i&gt;</span>
<span class="cm"> * &lt;/code&gt;</span>
<span class="cm"> * &lt;/pre&gt;</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * May values may be represented by a special tag: &lt;code&gt;&lt;null&gt;&lt;/code&gt;. An empty</span>
<span class="cm"> * element: &lt;code&gt;||&lt;/code&gt; is interpreted as the empty string:</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> * </span>
<span class="cm"> * &lt;pre&gt;</span>
<span class="cm"> *  &lt;code&gt;</span>
<span class="cm"> *  fid4=4||&lt;null&gt; -&gt; Feature( id=2, name=&quot;&quot;, geom=null )</span>
<span class="cm"> *  &lt;/code&gt;</span>
<span class="cm"> * &lt;/pre&gt;</span>
<span class="cm"> * </span>
<span class="cm"> * @author Jody Garnett</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PropertyAttributeReader</span> <span class="kd">implements</span> <span class="n">AttributeReader</span> <span class="o">{</span>
    <span class="n">BufferedReader</span> <span class="n">reader</span><span class="o">;</span>

    <span class="n">SimpleFeatureType</span> <span class="n">type</span><span class="o">;</span>

    <span class="n">String</span> <span class="n">line</span><span class="o">;</span>

    <span class="n">String</span> <span class="n">next</span><span class="o">;</span>

    <span class="n">String</span><span class="o">[]</span> <span class="n">text</span><span class="o">;</span>

    <span class="n">String</span> <span class="n">fid</span><span class="o">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Creates a new PropertyAttributeReader object.</span>
<span class="cm">     * </span>
<span class="cm">     * @param file File being read</span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     * @throws DataSourceException</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="nf">PropertyAttributeReader</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">typeName</span> <span class="o">=</span> <span class="n">typeName</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">namespace</span> <span class="o">=</span> <span class="n">namespace</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">FileReader</span><span class="o">(</span><span class="n">file</span><span class="o">));</span>

        <span class="c1">// read until &quot;_=&quot;;</span>
        <span class="k">while</span> <span class="o">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">line</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;_=&quot;</span><span class="o">))</span>
                <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">((</span><span class="n">line</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">line</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;_=&quot;</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="n">typeName</span> <span class="o">+</span> <span class="s">&quot; schema not available&quot;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">String</span> <span class="n">typeSpec</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">type</span> <span class="o">=</span> <span class="n">DataUtilities</span><span class="o">.</span><span class="na">createType</span><span class="o">(</span><span class="n">namespace</span><span class="o">,</span> <span class="n">typeName</span><span class="o">,</span> <span class="n">typeSpec</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SchemaException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">DataSourceException</span><span class="o">(</span><span class="n">typeName</span> <span class="o">+</span> <span class="s">&quot; schema not available&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">line</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * TypeName for the provided file.</span>
<span class="cm">     * </span>
<span class="cm">     * @param file File being read</span>
<span class="cm">     * @return suitable typeName</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">typeName</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">split</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="sc">&#39;.&#39;</span><span class="o">);</span>

        <span class="k">return</span> <span class="o">(</span><span class="n">split</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">?</span> <span class="n">name</span> <span class="o">:</span> <span class="n">name</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">split</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Namespace for the provided file</span>
<span class="cm">     * </span>
<span class="cm">     * @param file File being read</span>
<span class="cm">     * @return suitable namespace</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">namespace</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">File</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">getParentFile</span><span class="o">();</span>

        <span class="k">return</span> <span class="o">(</span><span class="n">parent</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="o">(</span><span class="n">parent</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
<p>Our constructor acquires the type information from the header, using a function from DataUtilities
to interpret the type specification. The filename is used as the name for the resulting
FeatureType, and the directory name is used for the namespace.</p>
<p>The <strong>BufferedReader</strong>, reader, is opened and it will be this class that allows us to stream over
contents as a series of Features.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We are opening this in the constructor in order raise an IOException if the
file cannot be used (rather than wait until next() is called).</p>
</div>
<p>We will use a two part strategy for determining if more content is available. We will try and
acquire the &#8216;next&#8217; line in the hasNext() method, using the next() method to update &#8216;line&#8217; to
the contents of &#8216;next&#8217;. All attribute operations will be performed against the current &#8216;line&#8217;.</p>
</li>
<li><p class="first">With these ideas in mind we can implement the required methods:</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="cm">/**</span>
<span class="cm">     * Number of attributes to expect based on header information.</span>
<span class="cm">     * </span>
<span class="cm">     * @return number of attribtues</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getAttributeCount</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">type</span><span class="o">.</span><span class="na">getAttributeCount</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * AttribtueDescriptor (name and type) for position marked by index.</span>
<span class="cm">     * </span>
<span class="cm">     * @param index</span>
<span class="cm">     * @return AttributeDescriptor describing attribute name and type</span>
<span class="cm">     * @throws ArrayIndexOutOfBoundsException</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">AttributeDescriptor</span> <span class="nf">getAttributeType</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">ArrayIndexOutOfBoundsException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">type</span><span class="o">.</span><span class="na">getDescriptor</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Close the internal reader accessing the file.</span>
<span class="cm">     * </span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">reader</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Check if the file has another line.</span>
<span class="cm">     * </span>
<span class="cm">     * @return &lt;code&gt;true&lt;/code&gt; if the file has another line</span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">next</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">next</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">next</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="cm">/**</span>
<span class="cm">     * Read the next line from the reader.</span>
<span class="cm">     * </span>
<span class="cm">     * @return line</span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     */</span>
    <span class="n">String</span> <span class="nf">readLine</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">while</span><span class="o">(</span> <span class="kc">true</span> <span class="o">){</span>
            <span class="n">String</span> <span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(</span> <span class="n">line</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">){</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// no more content</span>
            <span class="o">}</span>
            <span class="k">if</span><span class="o">(</span> <span class="n">line</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;#&quot;</span><span class="o">)</span> <span class="o">||</span> <span class="n">line</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;!&quot;</span><span class="o">)){</span>
                <span class="k">continue</span><span class="o">;</span> <span class="c1">// skip comments</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">line</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Retrieve the next line.</span>
<span class="cm">     * </span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     * @throws NoSuchElementException</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">next</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
            <span class="n">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

            <span class="kt">int</span> <span class="n">split</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="sc">&#39;=&#39;</span><span class="o">);</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">split</span><span class="o">);</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">split</span> <span class="o">+</span> <span class="mi">1</span><span class="o">).</span><span class="na">split</span><span class="o">(</span><span class="s">&quot;\\|&quot;</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">getAttributeCount</span><span class="o">()</span> <span class="o">!=</span> <span class="n">text</span><span class="o">.</span><span class="na">length</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">DataSourceException</span><span class="o">(</span><span class="s">&quot;format error: expected &quot;</span>
                        <span class="o">+</span> <span class="n">type</span><span class="o">.</span><span class="na">getAttributeCount</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; attributes, but found &quot;</span>
                        <span class="o">+</span> <span class="n">text</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="s">&quot;. [&quot;</span> <span class="o">+</span> <span class="n">line</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">NoSuchElementException</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Read attribute in position marked by &lt;code&gt;index&lt;/code&gt;.</span>
<span class="cm">     * </span>
<span class="cm">     * @param index Attribute position to read</span>
<span class="cm">     * @return Value for the attribtue in position &lt;code&gt;index&lt;/code&gt;</span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     * @throws ArrayIndexOutOfBoundsException</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">read</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span>
            <span class="n">ArrayIndexOutOfBoundsException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">line</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span>
                    <span class="s">&quot;No content available - did you remeber to call next?&quot;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">AttributeDescriptor</span> <span class="n">attType</span> <span class="o">=</span> <span class="n">type</span><span class="o">.</span><span class="na">getDescriptor</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>

        <span class="n">String</span> <span class="n">stringValue</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// read the value</span>
            <span class="n">stringValue</span> <span class="o">=</span> <span class="n">text</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>

            <span class="c1">// trim off any whitespace</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">stringValue</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">stringValue</span> <span class="o">=</span> <span class="n">stringValue</span><span class="o">.</span><span class="na">trim</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">stringValue</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">stringValue</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">e1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e1</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">stringValue</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// check for special &lt;null&gt; flag</span>
        <span class="k">if</span> <span class="o">(</span><span class="s">&quot;&lt;null&gt;&quot;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">stringValue</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">stringValue</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">stringValue</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">attType</span><span class="o">.</span><span class="na">isNillable</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">// Use of Converters to convert from String to requested java binding</span>
        <span class="n">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">Converters</span><span class="o">.</span><span class="na">convert</span><span class="o">(</span><span class="n">stringValue</span><span class="o">,</span> <span class="n">attType</span><span class="o">.</span><span class="na">getType</span><span class="o">()</span>
                <span class="o">.</span><span class="na">getBinding</span><span class="o">());</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">attType</span><span class="o">.</span><span class="na">getType</span><span class="o">()</span> <span class="k">instanceof</span> <span class="n">GeometryType</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// this is to be passed on in the geometry objects so the srs name</span>
            <span class="c1">// gets encoded</span>
            <span class="n">CoordinateReferenceSystem</span> <span class="n">crs</span> <span class="o">=</span> <span class="o">((</span><span class="n">GeometryType</span><span class="o">)</span> <span class="n">attType</span><span class="o">.</span><span class="na">getType</span><span class="o">())</span>
                    <span class="o">.</span><span class="na">getCoordinateReferenceSystem</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">crs</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// must be geometry, but check anyway</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="k">instanceof</span> <span class="n">Geometry</span><span class="o">)</span> <span class="o">{</span>
                    <span class="o">((</span><span class="n">Geometry</span><span class="o">)</span> <span class="n">value</span><span class="o">).</span><span class="na">setUserData</span><span class="o">(</span><span class="n">crs</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</li>
</ol>
<ol class="arabic" start="2">
<li><p class="first">Finally, since our file format does support FeatureID we will need a way to let
our FeatureReader know:</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="cm">/**</span>
<span class="cm">     * Retrieve the FeatureId identifying the current line.</span>
<span class="cm">     * </span>
<span class="cm">     * @return FeatureID for the current line.</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getFeatureID</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">line</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">fid</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
<p>We can make use of getFeatureID() to supply a FeatureID for FeatureReader.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Many other DataStores derive a FeatureID from their attributes, or the current
line number.</p>
<p>Since a FeatureID must start with a letter a common approach is to prepend
the TypeName followed by a dot to the line number, or database row ID number.</p>
<p>FeatureID generation example:</p>
<div class="last highlight-python"><div class="highlight"><pre>public String deriveFeatureID(){
    return type.getTypeName()+&quot;.&quot;+id_number;
}
</pre></div>
</div>
</div>
</li>
</ol>
</div>
<div class="section" id="datastorefactory">
<h3>DataStoreFactory<a class="headerlink" href="#datastorefactory" title="Permalink to this headline">¶</a></h3>
<p>To make your DataStore truly independent and plugable, you must create a class implementing the
<strong>DataStoreFactorySpi</strong> interface.</p>
<p>This allows the Service Provider Interface mechanism to dynamically plug in your new DataStore with
no implementation knowledge. Code that uses the DataStoreFinder can just add the new DataStore to
the classpath and it will work!</p>
<p>The DataStoreFactorySpi provides information on the Parameters required for construction.
DataStoreFactoryFinder provides the ability to create DataStores representing existing
information and the ability to create new physical storage.</p>
<ol class="arabic">
<li><p class="first">PropertyDataStoreFactory</p>
<ul class="simple">
<li>The &#8220;no argument&#8221; consturctor is required as it will be used by the
Factory Service Provider (SPI) plug-in system.</li>
<li>getImplementationHints() is used to report on any &#8220;Hints&#8221; used for configuration
by our factory. As an example our Factory could allow people to specify a specific
FeatureFactory to use when creating a feature for each line.</li>
</ul>
<p>Create PropertyDataStoreFactory as follows:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.geotools.data.property</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.awt.RenderingHints</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileNotFoundException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.geotools.data.DataStore</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.data.DataStoreFactorySpi</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * DataStore factory that creates</span>
<span class="cm"> * {@linkplain org.geotools.data.property.PropertyDataStore}s</span>
<span class="cm"> * </span>
<span class="cm"> * @author Jody Garnett</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PropertyDataStoreFactory</span> <span class="kd">implements</span> <span class="n">DataStoreFactorySpi</span> <span class="o">{</span>

    <span class="cm">/**</span>
<span class="cm">     * Public &quot;no arguments&quot; constructor called by Factory Service Provider</span>
<span class="cm">     * (SPI) based on entry in</span>
<span class="cm">     * META-INF/services/org.geotools.data.DataStoreFactorySpi</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="nf">PropertyDataStoreFactory</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * No implementation hints are provided at this time.</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">RenderingHints</span><span class="o">.</span><span class="na">Key</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">getImplementationHints</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyMap</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">We have a couple of methods to describe the DataStore.</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getDisplayName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;Properties&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getDescription</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;Allows access to Java Property files containing Feature information&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Test to see if this datastore is available, if it has all the appropriate</span>
<span class="cm">     * libraries to construct a datastore. This datastore just returns true for</span>
<span class="cm">     * now. This method is used for interactive applications, so as to not</span>
<span class="cm">     * advertise data store capabilities they don&#39;t actually have.</span>
<span class="cm">     * </span>
<span class="cm">     * @return &lt;tt&gt;true&lt;/tt&gt; if and only if this factory is available to create</span>
<span class="cm">     *         DataStores.</span>
<span class="cm">     * @task &lt;code&gt;true&lt;/code&gt; property datastore is always available</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isAvailable</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">The user is expected to supply a Map of connection parameters when creating
a datastore.</p>
<p>The allowable connection parameters are described using <em>Parameter</em> (as defined by gt-api docs).
This captures the &#8220;key&#8221; used to store the value in the map, and the expected java
type for the value.</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Param</span> <span class="n">DIRECTORY</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Param</span><span class="o">(</span><span class="s">&quot;directory&quot;</span><span class="o">,</span> <span class="n">File</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="s">&quot;Directory containting property files&quot;</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Param</span> <span class="n">NAMESPACE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Param</span><span class="o">(</span><span class="s">&quot;namespace&quot;</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="s">&quot;namespace of datastore&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>

    <span class="cm">/**</span>
<span class="cm">     * @see #DIRECTORY</span>
<span class="cm">     * @see PropertyDataStoreFactory#NAMESPACE</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Param</span><span class="o">[]</span> <span class="nf">getParametersInfo</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Param</span><span class="o">[]</span> <span class="o">{</span> <span class="n">DIRECTORY</span><span class="o">,</span> <span class="n">NAMESPACE</span> <span class="o">};</span>
    <span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">We have some code to check if a set of provided connection parameters
can actually be used.</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="cm">/**</span>
<span class="cm">     * Works for a file directory or property file</span>
<span class="cm">     * </span>
<span class="cm">     * @param params Connection parameters</span>
<span class="cm">     * @return true for connection parameters indicating a directory or property</span>
<span class="cm">     *         file</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">canProcess</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Serializable</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">directoryLookup</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">erp</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// can&#39;t process, just return false</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Lookups the directory containing property files in the params argument,</span>
<span class="cm">     * and returns the corresponding &lt;code&gt;java.io.File&lt;/code&gt;.</span>
<span class="cm">     * &lt;p&gt;</span>
<span class="cm">     * The file is first checked for existence as an absolute path in the</span>
<span class="cm">     * filesystem. If such a directory is not found, then it is treated as a</span>
<span class="cm">     * relative path, taking Java system property &lt;code&gt;&quot;user.dir&quot;&lt;/code&gt; as the</span>
<span class="cm">     * base.</span>
<span class="cm">     * &lt;/p&gt;</span>
<span class="cm">     * </span>
<span class="cm">     * @param params</span>
<span class="cm">     * @throws IllegalArgumentException if directory is not a directory.</span>
<span class="cm">     * @throws FileNotFoundException if directory does not exists</span>
<span class="cm">     * @throws IOException if {@linkplain #DIRECTORY} doesn&#39;t find parameter in</span>
<span class="cm">     *         &lt;code&gt;params&lt;/code&gt; file does not exists.</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">File</span> <span class="nf">directoryLookup</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">Serializable</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">FileNotFoundException</span><span class="o">,</span> <span class="n">IllegalArgumentException</span> <span class="o">{</span>
        <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="o">(</span><span class="n">File</span><span class="o">)</span> <span class="n">DIRECTORY</span><span class="o">.</span><span class="na">lookUp</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">file</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">File</span> <span class="n">currentDir</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;user.dir&quot;</span><span class="o">));</span>
            <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">DIRECTORY</span><span class="o">.</span><span class="na">lookUp</span><span class="o">(</span><span class="n">params</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
            <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">currentDir</span><span class="o">,</span> <span class="n">path</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">file</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">FileNotFoundException</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">file</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// check if they pointed to a properties file; and use the parent</span>
            <span class="c1">// directory</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getPath</span><span class="o">().</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&quot;.properties&quot;</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">file</span><span class="o">.</span><span class="na">getParentFile</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">()</span>
                        <span class="o">+</span> <span class="s">&quot; is not a directory&quot;</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The directoryLookup has gotten considerably more complicated since this tutorial
was first written. One of the benifits of PropertyDataStore being used
in real world situtations.</p>
</div>
</li>
<li><p class="first">Armed with a map of connection parameters we can now:</p>
<ul>
<li><p class="first">create a Datastore for an <strong>existing</strong> property file; and</p>
</li>
<li><p class="first">create a datastore for a <strong>new</strong> property file</p>
<p>Since initially our DataStore is read-only we will just throw an UnsupportedOperationException
at this time.</p>
</li>
</ul>
<p>Here is the code that finally calls our PropertyDataStore constructor:</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kd">public</span> <span class="n">DataStore</span> <span class="nf">createDataStore</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">Serializable</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">File</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">directoryLookup</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">namespaceURI</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">NAMESPACE</span><span class="o">.</span><span class="na">lookUp</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">dir</span><span class="o">.</span><span class="na">exists</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">dir</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">PropertyDataStore</span><span class="o">(</span><span class="n">dir</span><span class="o">,</span> <span class="n">namespaceURI</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&quot;Directory is required&quot;</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">DataStore</span> <span class="nf">createNewDataStore</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">Serializable</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">UnsupportedOperationException</span><span class="o">(</span><span class="s">&quot;PropertyDataStore is read-only&quot;</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">The Factory Service Provider (SPI) system operates by looking at the META-INF/services
folder and checking for implemetnations of DataStoreFactorySpi</p>
<p>To &#8220;register&#8221; our PropertyDataStoreFactory please create the following file:</p>
<ul class="simple">
<li>META-INF/services/org.geotools.data.DataStoreFactorySpi</li>
</ul>
<p>This file requires the filename of the factory that implements the DataStoreSpi interface.</p>
<p>Fill in the following content for your <strong>org.geotools.data.DataStoreFactorySpi</strong> file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">org</span><span class="o">.</span><span class="n">geotools</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tutorial</span><span class="o">.</span><span class="n">PropertiesDataStoreFactory</span>
</pre></div>
</div>
</li>
</ol>
<p>That is it, in the next section we will try out your new DataStore.</p>
</div>
</div>
<div class="section" id="part-3-using-property-datastore-to-read-files">
<h2>Part 3 - Using Property DataStore to Read Files<a class="headerlink" href="#part-3-using-property-datastore-to-read-files" title="Permalink to this headline">¶</a></h2>
<p>In this part we examine the abilities of the PropertyDataStore implemented in Part 2.</p>
<div class="section" id="datastore">
<h3>DataStore<a class="headerlink" href="#datastore" title="Permalink to this headline">¶</a></h3>
<p>Now that we have implemented a simple DataStore we can explore some of the capabilities made available to us.</p>
<p>PropertyDataStore API for data access:</p>
<ul class="simple">
<li>DataStore.getTypeNames()</li>
<li>DataStore.getSchema( typeName )</li>
<li>DataStore.getFeatureReader( featureType, filter, transaction )</li>
<li>DataStore.getFeatureSource( typeName )</li>
</ul>
<p>If you would like to follow along with these examples you can
<a class="reference download internal" href="../_downloads/PropertyExamples.java"><code class="xref download docutils literal"><span class="pre">PropertyExamples.java</span></code></a>.</p>
<ul>
<li><p class="first">DataStore.getTypeNames()</p>
<p>The method getTypeNames provides a list of the available types.</p>
<p>getTypeNames() example:</p>
<div class="highlight-java"><div class="highlight"><pre>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Serializable</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Serializable</span><span class="o">&gt;();</span>
        <span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;directory&quot;</span><span class="o">,</span> <span class="n">directory</span><span class="o">);</span>
        <span class="n">DataStore</span> <span class="n">store</span> <span class="o">=</span> <span class="n">DataStoreFinder</span><span class="o">.</span><span class="na">getDataStore</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>

        <span class="n">String</span> <span class="n">names</span><span class="o">[]</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">getTypeNames</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;typenames: &quot;</span> <span class="o">+</span> <span class="n">names</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;typename[0]: &quot;</span> <span class="o">+</span> <span class="n">names</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
</pre></div>
</div>
<p>Produces the following output (given a directory with example.properties):</p>
<div class="highlight-text"><div class="highlight"><pre>typenames: 1
typename[0]: example
</pre></div>
</div>
</li>
<li><p class="first">DataStore.getSchema( typeName )</p>
<p>The method getSchema( typeName ) provides access to a FeatureType referenced by a type name.</p>
<p>getSchema( typeName ) example:</p>
<div class="highlight-java"><div class="highlight"><pre>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Serializable</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Serializable</span><span class="o">&gt;();</span>
        <span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;directory&quot;</span><span class="o">,</span> <span class="n">directory</span><span class="o">);</span>
        <span class="n">DataStore</span> <span class="n">store</span> <span class="o">=</span> <span class="n">DataStoreFinder</span><span class="o">.</span><span class="na">getDataStore</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>

        <span class="n">SimpleFeatureType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">getSchema</span><span class="o">(</span><span class="s">&quot;example&quot;</span><span class="o">);</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;       typeName: &quot;</span> <span class="o">+</span> <span class="n">type</span><span class="o">.</span><span class="na">getTypeName</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;           name: &quot;</span> <span class="o">+</span> <span class="n">type</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;attribute count: &quot;</span> <span class="o">+</span> <span class="n">type</span><span class="o">.</span><span class="na">getAttributeCount</span><span class="o">());</span>

        <span class="n">AttributeDescriptor</span> <span class="n">id</span> <span class="o">=</span> <span class="n">type</span><span class="o">.</span><span class="na">getDescriptor</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;attribute &#39;id&#39;    name:&quot;</span> <span class="o">+</span> <span class="n">id</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;attribute &#39;id&#39;    type:&quot;</span> <span class="o">+</span> <span class="n">id</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;attribute &#39;id&#39; binding:&quot;</span>
                <span class="o">+</span> <span class="n">id</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">getDescription</span><span class="o">());</span>

        <span class="n">AttributeDescriptor</span> <span class="n">name</span> <span class="o">=</span> <span class="n">type</span><span class="o">.</span><span class="na">getDescriptor</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;attribute &#39;name&#39;    name:&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;attribute &#39;name&#39; binding:&quot;</span>
                <span class="o">+</span> <span class="n">name</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">getBinding</span><span class="o">());</span>
</pre></div>
</div>
<p>Produces the following output:</p>
<div class="highlight-text"><div class="highlight"><pre>       typeName: example
           name: example4149306500761583641:example
attribute count: 3
attribute &#39;id&#39;    name:id
attribute &#39;id&#39;    type:AttributeTypeImpl id&lt;Integer&gt;
attribute &#39;id&#39; binding:null
attribute &#39;name&#39;    name:name
attribute &#39;name&#39; binding:class java.lang.String
</pre></div>
</div>
</li>
<li><p class="first">DataStore.getFeatureReader( query, transaction )</p>
<p>The method getFeatureReader( query, transaction ) allows access to the contents
of our DataStore.</p>
<p>The method signature may be more complicated than expected, we certainly did not talk
about Query or Transactions when we implemented our PropertyDataStore. This is something
that AbstractDataStore is handling for you and will be discussed later in the section
on optimisation.</p>
<ul>
<li><p class="first">Query.getTypeName()</p>
<p>Determines which FeatureType is being requested. In addition, Query supports the
customization attributes, namespace, and typeName requested from the DataStore.
While you may use DataStore.getSchema( typeName ) to retrieve the types as specified by
the DataStore, you may also create your own FeatureType to limit the attributes returned
or cast the result into a specific namespace.</p>
</li>
<li><p class="first">Query.getFilter()</p>
<p>Used to define constraints on which features should be fetched. The constraints
can be on spatial and non-spatial attributes of the features.</p>
</li>
<li><p class="first">Query.getPropertiesNames()</p>
<p>Allows you to limit the number of properties of the returned Features to only those
you are interested in.</p>
</li>
<li><p class="first">Query.getMaxFeatures()</p>
<p>Defines an upper limit for the number of features returned.</p>
</li>
<li><p class="first">Query.getHandle()</p>
<p>User-supplied name used to describe a query in user&#8217;s terms in any generated error messages.</p>
</li>
<li><p class="first">Query.getCoordinateSystem()</p>
<p>Used to force the use of a user-supplied CoordinateSystem (rather than the one supplied
by the DataStore). This capability will allow client code to use our DataStore with a
CoordinateSystem of their choice. The coordinates returned by the DataStore will not be
modified in any way.</p>
</li>
<li><p class="first">Query.getCoordinateSystemReproject()</p>
<p>Used to reproject the Geometries provided by a DataStore from their original value (or
the one provided by Query.getCoordinateSystem) into a different coordinate system.
The coordinate returned by the DataStore will be processed , either natively by
Advanced DataStores, or using GeoTools reprojection routines.</p>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Since this tutorial was writen Query has expanding its capabilities
(and the capabilities of your DataStore) to include support for reprojection.</p>
<p class="last">It also offers an &#8220;open ended&#8221; pathway for expansion using &#8220;query hints&#8221;.</p>
</div>
<ul>
<li><p class="first">Transaction</p>
<p>Allows access the contents of a DataStore during modification.</p>
</li>
</ul>
<p>With all of that in mind we can now proceed to our
DataStore.getFeatureReader( featureType, filter, transaction ) example:</p>
<div class="highlight-java"><div class="highlight"><pre>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Serializable</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Serializable</span><span class="o">&gt;();</span>
        <span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;directory&quot;</span><span class="o">,</span> <span class="n">directory</span><span class="o">);</span>
        <span class="n">DataStore</span> <span class="n">datastore</span> <span class="o">=</span> <span class="n">DataStoreFinder</span><span class="o">.</span><span class="na">getDataStore</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>

        <span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">(</span><span class="s">&quot;example&quot;</span><span class="o">);</span>
        <span class="n">FeatureReader</span><span class="o">&lt;</span><span class="n">SimpleFeatureType</span><span class="o">,</span> <span class="n">SimpleFeature</span><span class="o">&gt;</span> <span class="n">reader</span> <span class="o">=</span> <span class="n">datastore</span>
                <span class="o">.</span><span class="na">getFeatureReader</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="n">Transaction</span><span class="o">.</span><span class="na">AUTO_COMMIT</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">SimpleFeature</span> <span class="n">feature</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;feature &quot;</span> <span class="o">+</span> <span class="n">count</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span> <span class="n">feature</span><span class="o">.</span><span class="na">getID</span><span class="o">());</span>
                <span class="n">count</span><span class="o">++;</span>
            <span class="o">}</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;read in &quot;</span> <span class="o">+</span> <span class="n">count</span> <span class="o">+</span> <span class="s">&quot; features&quot;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">reader</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
</pre></div>
</div>
<p>Produces the following output:</p>
<div class="highlight-text"><div class="highlight"><pre>feature 0: fid1
feature 1: fid2
feature 2: fid3
feature 3: fid4
read in 4 features
</pre></div>
</div>
<p>Example with a quick &#8220;selection&#8221; Filter:</p>
<div class="highlight-java"><div class="highlight"><pre>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Serializable</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Serializable</span><span class="o">&gt;();</span>
        <span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;directory&quot;</span><span class="o">,</span> <span class="n">directory</span><span class="o">);</span>
        <span class="n">DataStore</span> <span class="n">store</span> <span class="o">=</span> <span class="n">DataStoreFinder</span><span class="o">.</span><span class="na">getDataStore</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>

        <span class="n">FilterFactory</span> <span class="n">ff</span> <span class="o">=</span> <span class="n">CommonFactoryFinder</span><span class="o">.</span><span class="na">getFilterFactory</span><span class="o">();</span>

        <span class="n">Set</span><span class="o">&lt;</span><span class="n">FeatureId</span><span class="o">&gt;</span> <span class="n">selection</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">FeatureId</span><span class="o">&gt;();</span>
        <span class="n">selection</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ff</span><span class="o">.</span><span class="na">featureId</span><span class="o">(</span><span class="s">&quot;fid1&quot;</span><span class="o">));</span>

        <span class="n">Filter</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="n">selection</span><span class="o">);</span>
        <span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">(</span><span class="s">&quot;example&quot;</span><span class="o">,</span> <span class="n">filter</span><span class="o">);</span>

        <span class="n">FeatureReader</span><span class="o">&lt;</span><span class="n">SimpleFeatureType</span><span class="o">,</span> <span class="n">SimpleFeature</span><span class="o">&gt;</span> <span class="n">reader</span> <span class="o">=</span> <span class="n">store</span>
                <span class="o">.</span><span class="na">getFeatureReader</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="n">Transaction</span><span class="o">.</span><span class="na">AUTO_COMMIT</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">SimpleFeature</span> <span class="n">feature</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;feature &quot;</span> <span class="o">+</span> <span class="n">feature</span><span class="o">.</span><span class="na">getID</span><span class="o">());</span>

                <span class="k">for</span> <span class="o">(</span><span class="n">Property</span> <span class="n">property</span> <span class="o">:</span> <span class="n">feature</span><span class="o">.</span><span class="na">getProperties</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot;\t&quot;</span><span class="o">);</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">property</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot; = &quot;</span><span class="o">);</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">property</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">reader</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
</pre></div>
</div>
<p>Produces the following output:</p>
<div class="highlight-text"><div class="highlight"><pre>feature fid1
	id = 1
	name = jody garnett
	geom = POINT (0 0)
</pre></div>
</div>
</li>
<li><p class="first">DataStore.getFeatureSource( typeName )</p>
<p>This method is the gateway to our high level as provided by an instance of FeatureSource,
FeatureStore or FeatureLocking. The returned instance represents the contents of a single
named FeatureType provided by the DataStore. The type of the returned instance indicates
the capabilities available.</p>
<p>This far in our tutorial PropertyDataStore will only support an instance of FeatureSource.</p>
<p>Example getFeatureSource:</p>
<div class="highlight-java"><div class="highlight"><pre>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Serializable</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Serializable</span><span class="o">&gt;();</span>
        <span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;directory&quot;</span><span class="o">,</span> <span class="n">directory</span><span class="o">);</span>
        <span class="n">DataStore</span> <span class="n">store</span> <span class="o">=</span> <span class="n">DataStoreFinder</span><span class="o">.</span><span class="na">getDataStore</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>

        <span class="n">SimpleFeatureSource</span> <span class="n">featureSource</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">getFeatureSource</span><span class="o">(</span><span class="s">&quot;example&quot;</span><span class="o">);</span>

        <span class="n">Filter</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">CQL</span><span class="o">.</span><span class="na">toFilter</span><span class="o">(</span><span class="s">&quot;name = &#39;dave&#39;&quot;</span><span class="o">);</span>
        <span class="n">SimpleFeatureCollection</span> <span class="n">features</span> <span class="o">=</span> <span class="n">featureSource</span><span class="o">.</span><span class="na">getFeatures</span><span class="o">(</span><span class="n">filter</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;found :&quot;</span> <span class="o">+</span> <span class="n">features</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; feature&quot;</span><span class="o">);</span>
        <span class="n">SimpleFeatureIterator</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="na">features</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">SimpleFeature</span> <span class="n">feature</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                <span class="n">Geometry</span> <span class="n">geometry</span> <span class="o">=</span> <span class="o">(</span><span class="n">Geometry</span><span class="o">)</span> <span class="n">feature</span><span class="o">.</span><span class="na">getDefaultGeometry</span><span class="o">();</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">feature</span><span class="o">.</span><span class="na">getID</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; location &quot;</span> <span class="o">+</span> <span class="n">geometry</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">iterator</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
</pre></div>
</div>
<p>Producing the following output:</p>
<div class="highlight-text"><div class="highlight"><pre>found :1 feature
fid3 location POINT (20 20)
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="featuresource">
<h3>FeatureSource<a class="headerlink" href="#featuresource" title="Permalink to this headline">¶</a></h3>
<p>FeatureSource provides the ability to query a DataStore and represents the contents of a single
FeatureType. In our example, the PropertiesDataStore represents a directory full of properties
files. FeatureSource will represent a single one of those files.</p>
<p>FeatureSource defines:</p>
<ul class="simple">
<li>FeatureSource.getFeatures( query ) - request features specified by query</li>
<li>FeatureSource.getFeatures( filter ) - request features based on constraints</li>
<li>FeatureSource.getFeatures() - request all features</li>
<li>FeatureSource.getSchema() - acquire FeatureType</li>
<li>FeatureSource.getBounds - return the bounding box of all features</li>
<li>FeatureSource.getBounds( query ) - request bounding box of specified features</li>
<li>FeatureSource.getCount( query ) - request number of features specified by query</li>
</ul>
<p>FeatureSource also defines an event notification system and provides access to the DataStore
which created it. You may have more than one FeatureSource operating against a file at any time.</p>
</div>
<div class="section" id="featurecollection">
<h3>FeatureCollection<a class="headerlink" href="#featurecollection" title="Permalink to this headline">¶</a></h3>
<div class="sidebar">
<p class="first sidebar-title">FeatureResults</p>
<p>FeatureResults is the original name of FeatureCollection.
Some of these methods have been replaced such as the use of
DataUtilities.collection( featureCollection ) to load
the contents into memory.</p>
<p>It is interesting to note the design goal of capturing a
prepared statement (rather than loading the features into memory).</p>
<p class="last">The class was renamed FeatureCollection to help those migrating
from GeoTools 1.0.</p>
</div>
<p>While the FeatureSource API does allow you to represent a named FeatureType, it still does not
allow direct access to a FeatureReader. The getFeatures methods actually return an instance of
FeatureCollection.</p>
<p>FeatureCollection defines:</p>
<ul class="simple">
<li>FeatureCollection.getSchmea()</li>
<li>FeatureCollection.features() - access to a FeatureIterator</li>
<li>FeatureCollection.accepts( visitor, progress )</li>
<li>FeatureCollection.getBounds() - bounding box of features</li>
<li>FeatureCollection.getCount() - number of features</li>
<li>DataUtilities.collection( featureCollection ) - used to load features into memory</li>
</ul>
<p>FeatureCollection is the closest thing we have to a prepared request. Many DataStores are able to
provide optimised implementations that handles the above methods natively.</p>
<ul>
<li><p class="first">FeatureCollection Example:</p>
<div class="highlight-java"><div class="highlight"><pre>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Serializable</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Serializable</span><span class="o">&gt;();</span>
        <span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;directory&quot;</span><span class="o">,</span> <span class="n">directory</span><span class="o">);</span>
        <span class="n">DataStore</span> <span class="n">store</span> <span class="o">=</span> <span class="n">DataStoreFinder</span><span class="o">.</span><span class="na">getDataStore</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>

        <span class="n">SimpleFeatureSource</span> <span class="n">featureSource</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">getFeatureSource</span><span class="o">(</span><span class="s">&quot;example&quot;</span><span class="o">);</span>
        <span class="n">SimpleFeatureCollection</span> <span class="n">featureCollection</span> <span class="o">=</span> <span class="n">featureSource</span><span class="o">.</span><span class="na">getFeatures</span><span class="o">();</span>
        <span class="n">SimpleFeatureIterator</span> <span class="n">features</span> <span class="o">=</span> <span class="n">featureCollection</span><span class="o">.</span><span class="na">features</span><span class="o">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">features</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">features</span><span class="o">.</span><span class="na">next</span><span class="o">().</span><span class="na">getID</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">features</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;  contents:&quot;</span> <span class="o">+</span> <span class="n">list</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;     count:&quot;</span> <span class="o">+</span> <span class="n">featureSource</span><span class="o">.</span><span class="na">getCount</span><span class="o">(</span><span class="n">Query</span><span class="o">.</span><span class="na">ALL</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;    bounds:&quot;</span> <span class="o">+</span> <span class="n">featureSource</span><span class="o">.</span><span class="na">getBounds</span><span class="o">(</span><span class="n">Query</span><span class="o">.</span><span class="na">ALL</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;      size:&quot;</span> <span class="o">+</span> <span class="n">featureCollection</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;    bounds:&quot;</span> <span class="o">+</span> <span class="n">featureCollection</span><span class="o">.</span><span class="na">getBounds</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;collection: &quot;</span>
                <span class="o">+</span> <span class="n">DataUtilities</span><span class="o">.</span><span class="na">collection</span><span class="o">(</span><span class="n">featureCollection</span><span class="o">).</span><span class="na">size</span><span class="o">());</span>
</pre></div>
</div>
<p>With the following output:</p>
<div class="highlight-text"><div class="highlight"><pre>  contents:[fid1, fid2, fid3, fid4]
     count:-1
    bounds:null
      size:4
    bounds:ReferencedEnvelope[0.0 : 30.0, 0.0 : 30.0]
collection: 4
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>In the above example, FeatureSource.count(Query.ALL) will return -1, indicating that the value
is expensive for the DataStore to calculate, or at least that our PropertyDataStore
implementation does not provide an optimised implementation.</p>
<p>FeatureCollection.size() will always produce an answer</p>
<p>You can think of this as:</p>
<ul class="last simple">
<li>FeatureSource is a way to perform a quick check for a precanned answer for count and bounds.
Some formats such as shapefile will keep this information in the header at the top of the
file.</li>
<li>FeatureCollection checks the contents, and possibly checks each item, for an answer to
size and bounds.</li>
</ul>
</div>
<p>Care should be taken when using the collection() method to capture the contents of a DataStore in
memory. GIS applications often produce large volumes of information and can place a strain
on memory use.</p>
</div>
</div>
<div class="section" id="part-4-making-property-datastore-writable">
<h2>Part 4 - Making Property DataStore Writable<a class="headerlink" href="#part-4-making-property-datastore-writable" title="Permalink to this headline">¶</a></h2>
<p>In this part we will complete the PropertyDataStore started above. At the end of this section we
will have a full functional PropertyDataStore supporting both read and write operations.</p>
<p>The DataStore API has two methods that are involved in making content writable.</p>
<ul class="simple">
<li>DataStore.getFeatureWriter( typeName )</li>
<li>DataStore.createSchema( featureType )</li>
</ul>
<p>AbstractDataStore asks us to implement two things in our subclass:</p>
<ul class="simple">
<li>PropertyDataStore() constructor must call super( true ) to indicate we are
working with writable content</li>
<li>PropertyDataStore.getFeatureWriter( typeName )</li>
</ul>
<p>FeatureWriter defines the following methods:</p>
<ul class="simple">
<li>FeatureWriter.getFeatureType</li>
<li>FeatureWriter.hasNext</li>
<li>FeatureWriter.next</li>
<li>FeatureWriter.write</li>
<li>FeatureWriter.remove</li>
<li>FeatureWriter.close</li>
</ul>
<p>Change notification for users is made available through several FeatureSource methods:</p>
<ul class="simple">
<li>FeatureSource.addFeatureListener( featureListener )</li>
<li>FeatureSource.removeFeatureListener( featureListener )</li>
</ul>
<p>To trigger the featureListeners we will make use of several helper methods in AbstractDataSource:</p>
<ul class="simple">
<li>AbstractDataStore.fireAdded( feature )</li>
<li>AbstractDataStore.fireRemoved( feature )</li>
<li>AbstractDataStore.fireChanged( before, after )</li>
</ul>
<div class="section" id="propertydatastorefactory">
<h3>PropertyDataStoreFactory<a class="headerlink" href="#propertydatastorefactory" title="Permalink to this headline">¶</a></h3>
<p>Now that we are going to be writing files we can fill in the createNewDataStore method.</p>
<ol class="arabic">
<li><p class="first">Open up PropertyDataStoreFactory and replace createNewDataStore with the following:</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kd">public</span> <span class="n">DataStore</span> <span class="nf">createNewDataStore</span><span class="o">(</span><span class="n">Map</span> <span class="n">params</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    	<span class="n">File</span> <span class="n">dir</span> <span class="o">=</span> <span class="o">(</span><span class="n">File</span><span class="o">)</span><span class="n">DIRECTORY</span><span class="o">.</span><span class="na">lookUp</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">dir</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="n">dir</span> <span class="o">+</span> <span class="s">&quot; already exists&quot;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kt">boolean</span> <span class="n">created</span><span class="o">;</span>

        <span class="n">created</span> <span class="o">=</span> <span class="n">dir</span><span class="o">.</span><span class="na">mkdir</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">created</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&quot;Could not create the directory&quot;</span> <span class="o">+</span> <span class="n">dir</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">String</span> <span class="n">namespaceURI</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">NAMESPACE</span><span class="o">.</span><span class="na">lookUp</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">PropertyDataStore</span><span class="o">(</span><span class="n">dir</span><span class="o">,</span><span class="n">namespaceURI</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
<p>No surprises here; the code creates a directory for PropertyDataStore to work in.</p>
</li>
</ol>
</div>
<div class="section" id="id1">
<h3>PropertyDataStore<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">To start with, we need to make a change to our PropertyDataStore constructor:</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kd">public</span> <span class="nf">PropertyDataStore</span><span class="o">(</span><span class="n">File</span> <span class="n">dir</span><span class="o">,</span> <span class="n">String</span> <span class="n">namespaceURI</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span> <span class="c1">// true indicates we implement getFeatureWriter</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">dir</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="n">dir</span> <span class="o">+</span> <span class="s">&quot; is not a directory&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">namespaceURI</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">namespaceURI</span> <span class="o">=</span> <span class="n">dir</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">dir</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">namespaceURI</span> <span class="o">=</span> <span class="n">namespaceURI</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
<p>This change will tell AbstractDataStore that our subclass is willing to modify Features.</p>
</li>
<li><p class="first">Implement createSchema( featureType)</p>
<p>This method provides the ability to create a new FeatureType. For our DataStore we
will use this to create new properties files.</p>
<p>To implement this method we will once again make use of the DataUtilities class.</p>
<p>Add createSchema( featureType ):</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createSchema</span><span class="o">(</span><span class="n">SimpleFeatureType</span> <span class="n">featureType</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">typeName</span> <span class="o">=</span> <span class="n">featureType</span><span class="o">.</span><span class="na">getTypeName</span><span class="o">();</span>
        <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">directory</span><span class="o">,</span> <span class="n">typeName</span> <span class="o">+</span> <span class="s">&quot;.properties&quot;</span><span class="o">);</span>
        <span class="n">BufferedWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedWriter</span><span class="o">(</span><span class="k">new</span> <span class="n">FileWriter</span><span class="o">(</span><span class="n">file</span><span class="o">));</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">&quot;_=&quot;</span><span class="o">);</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">DataUtilities</span><span class="o">.</span><span class="na">spec</span><span class="o">(</span><span class="n">featureType</span><span class="o">));</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Implement getFeatureWriter( typeName )</p>
<p>FeatureWriter is the low-level API storing Feature content. This method is not part of the
public DataStore API and is only used by AbstractDataStore.</p>
<p>Add getFeatureWriter( typeName ):</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kd">protected</span> <span class="n">FeatureWriter</span><span class="o">&lt;</span><span class="n">SimpleFeatureType</span><span class="o">,</span> <span class="n">SimpleFeature</span><span class="o">&gt;</span> <span class="nf">createFeatureWriter</span><span class="o">(</span><span class="n">String</span> <span class="n">typeName</span><span class="o">,</span>
            <span class="n">Transaction</span> <span class="n">transaction</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">PropertyFeatureWriter</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">typeName</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</li>
</ol>
<blockquote>
<div>FeatureWriter is less intuitive than FeatureReader in that it does not follow the example of
Iterator as closely.</div></blockquote>
</div>
<div class="section" id="propertyfeaturewriter">
<h3>PropertyFeatureWriter<a class="headerlink" href="#propertyfeaturewriter" title="Permalink to this headline">¶</a></h3>
<p>Our implementation of a FeatureWriter needs to do two things: support the FeatureWriter interface
and inform the DataStore of modifications.</p>
<ol class="arabic">
<li><p class="first">Create the file PropertyFeatureWriter.java:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.geotools.data.property</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.FileChannel</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.geotools.data.DataSourceException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.data.DataUtilities</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.data.FeatureWriter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.data.Transaction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.factory.Hints</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.feature.simple.SimpleFeatureBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.geometry.jts.ReferencedEnvelope</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.feature.IllegalAttributeException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.feature.simple.SimpleFeature</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.feature.simple.SimpleFeatureType</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Uses PropertyAttributeWriter to generate a property file on disk.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * @source $URL$</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PropertyFeatureWriter</span> <span class="kd">implements</span>
        <span class="n">FeatureWriter</span><span class="o">&lt;</span><span class="n">SimpleFeatureType</span><span class="o">,</span> <span class="n">SimpleFeature</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="n">PropertyDataStore</span> <span class="n">store</span><span class="o">;</span>
    <span class="n">File</span> <span class="n">read</span><span class="o">;</span>
    <span class="n">PropertyAttributeReader</span> <span class="n">reader</span><span class="o">;</span>
    <span class="n">File</span> <span class="n">write</span><span class="o">;</span>
    <span class="n">PropertyAttributeWriter</span> <span class="n">writer</span><span class="o">;</span>
    <span class="n">SimpleFeature</span> <span class="n">origional</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">SimpleFeature</span> <span class="n">live</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">PropertyFeatureWriter</span><span class="o">(</span><span class="n">PropertyDataStore</span> <span class="n">dataStore</span><span class="o">,</span> <span class="n">String</span> <span class="n">typeName</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">store</span> <span class="o">=</span> <span class="n">dataStore</span><span class="o">;</span>
        <span class="n">File</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">directory</span><span class="o">;</span>
        <span class="n">read</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">dir</span><span class="o">,</span> <span class="n">typeName</span> <span class="o">+</span> <span class="s">&quot;.properties&quot;</span><span class="o">);</span>
        <span class="n">write</span> <span class="o">=</span> <span class="n">File</span><span class="o">.</span><span class="na">createTempFile</span><span class="o">(</span><span class="n">typeName</span> <span class="o">+</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">(),</span>
                <span class="kc">null</span><span class="o">,</span> <span class="n">dir</span><span class="o">);</span>

        <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PropertyAttributeReader</span><span class="o">(</span><span class="n">read</span><span class="o">);</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PropertyAttributeWriter</span><span class="o">(</span><span class="n">write</span><span class="o">,</span> <span class="n">reader</span><span class="o">.</span><span class="na">type</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
<p>Our constructor creates a PropertyAttributeReader to access the existing contents of
the DataStore. We made use of PropertyAttributeReader to implement
PropertyFeatureReader in Section 1.</p>
</li>
</ol>
<blockquote>
<div>We also create a PropertyAttributeWriter operating against a temporary file. When the
FeatureWriter is closed we will delete the original file and replace it with our new file.</div></blockquote>
<ol class="arabic" start="2">
<li><p class="first">Add FeatureWriter.getFeatureType() implementation:</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kd">public</span> <span class="n">SimpleFeatureType</span> <span class="nf">getFeatureType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">reader</span><span class="o">.</span><span class="na">type</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Add hasNext() implementation:</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kt">long</span> <span class="n">nextFid</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span> <span class="c1">// seed with a big number</span>
    <span class="kd">public</span> <span class="n">SimpleFeature</span> <span class="nf">next</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">writer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&quot;Writer has been closed&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">String</span> <span class="n">fid</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">SimpleFeatureType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">type</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">hasNext</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">reader</span><span class="o">.</span><span class="na">next</span><span class="o">();</span> <span class="c1">// grab next line</span>

                <span class="n">fid</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">getFeatureID</span><span class="o">();</span>
                <span class="n">Object</span> <span class="n">values</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="n">reader</span><span class="o">.</span><span class="na">getAttributeCount</span><span class="o">()];</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reader</span><span class="o">.</span><span class="na">getAttributeCount</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="n">values</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="n">origional</span> <span class="o">=</span> <span class="n">SimpleFeatureBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">values</span><span class="o">,</span> <span class="n">fid</span><span class="o">);</span>
                <span class="n">live</span> <span class="o">=</span> <span class="n">SimpleFeatureBuilder</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">origional</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">live</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">fid</span> <span class="o">=</span> <span class="n">type</span><span class="o">.</span><span class="na">getTypeName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="o">(</span><span class="n">nextFid</span><span class="o">++);</span>
                <span class="n">Object</span> <span class="n">values</span><span class="o">[]</span> <span class="o">=</span> <span class="n">DataUtilities</span><span class="o">.</span><span class="na">defaultValues</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>

                <span class="n">origional</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="n">live</span> <span class="o">=</span> <span class="n">SimpleFeatureBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">values</span><span class="o">,</span> <span class="n">fid</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">live</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAttributeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Problem creating feature &quot;</span>
                    <span class="o">+</span> <span class="o">(</span><span class="n">fid</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">fid</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="o">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">DataSourceException</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></div>
</div>
<p>Our FeatureWriter makes use of two Features:</p>
<ul class="simple">
<li>original: the feature provided by PropertyAttributeReader</li>
<li>live: a duplicate of original provided to the user for modification</li>
</ul>
<p>When the FeatureWriter is used to write or remove information, the contents of both live
and feature are set to null. If this has not been done already we will write out the
current feature.</p>
</li>
<li><p class="first">Add the helper function writeImplementation( Feature ):</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">writeImplementation</span><span class="o">(</span><span class="n">SimpleFeature</span> <span class="n">f</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">fid</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="na">getID</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span> <span class="n">f</span><span class="o">.</span><span class="na">getUserData</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">Hints</span><span class="o">.</span><span class="na">USE_PROVIDED_FID</span><span class="o">)</span> <span class="o">)</span> <span class="o">){</span>
            <span class="k">if</span><span class="o">(</span> <span class="n">f</span><span class="o">.</span><span class="na">getUserData</span><span class="o">().</span><span class="na">containsKey</span><span class="o">(</span><span class="n">Hints</span><span class="o">.</span><span class="na">PROVIDED_FID</span><span class="o">)){</span>
                <span class="n">fid</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">f</span><span class="o">.</span><span class="na">getUserData</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">Hints</span><span class="o">.</span><span class="na">PROVIDED_FID</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">writeFeatureID</span><span class="o">(</span><span class="n">fid</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">f</span><span class="o">.</span><span class="na">getAttributeCount</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">value</span> <span class="o">);</span>            
        <span class="o">}</span>
    <span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Add next() implementation:</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kt">long</span> <span class="n">nextFid</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span> <span class="c1">// seed with a big number</span>
    <span class="kd">public</span> <span class="n">SimpleFeature</span> <span class="nf">next</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">writer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&quot;Writer has been closed&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">String</span> <span class="n">fid</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">SimpleFeatureType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">type</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">hasNext</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">reader</span><span class="o">.</span><span class="na">next</span><span class="o">();</span> <span class="c1">// grab next line</span>

                <span class="n">fid</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">getFeatureID</span><span class="o">();</span>
                <span class="n">Object</span> <span class="n">values</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="n">reader</span><span class="o">.</span><span class="na">getAttributeCount</span><span class="o">()];</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reader</span><span class="o">.</span><span class="na">getAttributeCount</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="n">values</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="n">origional</span> <span class="o">=</span> <span class="n">SimpleFeatureBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">values</span><span class="o">,</span> <span class="n">fid</span><span class="o">);</span>
                <span class="n">live</span> <span class="o">=</span> <span class="n">SimpleFeatureBuilder</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">origional</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">live</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">fid</span> <span class="o">=</span> <span class="n">type</span><span class="o">.</span><span class="na">getTypeName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="o">(</span><span class="n">nextFid</span><span class="o">++);</span>
                <span class="n">Object</span> <span class="n">values</span><span class="o">[]</span> <span class="o">=</span> <span class="n">DataUtilities</span><span class="o">.</span><span class="na">defaultValues</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>

                <span class="n">origional</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="n">live</span> <span class="o">=</span> <span class="n">SimpleFeatureBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">values</span><span class="o">,</span> <span class="n">fid</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">live</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAttributeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Problem creating feature &quot;</span>
                    <span class="o">+</span> <span class="o">(</span><span class="n">fid</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">fid</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="o">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">DataSourceException</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></div>
</div>
<p>The next method is used for two purposes:</p>
<ul class="simple">
<li>To access Features for modification or removal (when working through existing content)</li>
<li>To create new Features (when working past the end of the file)</li>
</ul>
<p>To access existing Features, the AttributeReader is advanced, the current attribute and feature ID assembled into a Feature. This Feature is then duplicated and returned to the user. We will later compare the original to the user&#8217;s copy to check if any modifications have been made.</p>
</li>
<li><p class="first">Add write() implementation:</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">live</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&quot;No current feature to write&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">live</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">origional</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">writeImplementation</span><span class="o">(</span><span class="n">origional</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">writeImplementation</span><span class="o">(</span><span class="n">live</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">typeName</span> <span class="o">=</span> <span class="n">live</span><span class="o">.</span><span class="na">getFeatureType</span><span class="o">().</span><span class="na">getTypeName</span><span class="o">();</span>
            <span class="n">Transaction</span> <span class="n">autoCommit</span> <span class="o">=</span> <span class="n">Transaction</span><span class="o">.</span><span class="na">AUTO_COMMIT</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">origional</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">ReferencedEnvelope</span> <span class="n">bounds</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReferencedEnvelope</span><span class="o">();</span>
                <span class="n">bounds</span><span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="n">live</span><span class="o">.</span><span class="na">getBounds</span><span class="o">());</span>
                <span class="n">bounds</span><span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="n">origional</span><span class="o">.</span><span class="na">getBounds</span><span class="o">());</span>
                <span class="n">store</span><span class="o">.</span><span class="na">listenerManager</span><span class="o">.</span><span class="na">fireFeaturesChanged</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">autoCommit</span><span class="o">,</span>
                        <span class="n">bounds</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">store</span><span class="o">.</span><span class="na">listenerManager</span><span class="o">.</span><span class="na">fireFeaturesAdded</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">autoCommit</span><span class="o">,</span>
                        <span class="n">ReferencedEnvelope</span><span class="o">.</span><span class="na">reference</span><span class="o">(</span><span class="n">live</span><span class="o">.</span><span class="na">getBounds</span><span class="o">()),</span> <span class="kc">false</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">origional</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">live</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
<p>In the write method we will need to check to see whether the user has changed anything. If so,
we will need to remember to issue event notification after writing out their changes.</p>
</li>
<li><p class="first">Add remove() implementation:</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">live</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&quot;No current feature to remove&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">origional</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">typeName</span> <span class="o">=</span> <span class="n">live</span><span class="o">.</span><span class="na">getFeatureType</span><span class="o">().</span><span class="na">getTypeName</span><span class="o">();</span>
            <span class="n">Transaction</span> <span class="n">autoCommit</span> <span class="o">=</span> <span class="n">Transaction</span><span class="o">.</span><span class="na">AUTO_COMMIT</span><span class="o">;</span>
            <span class="n">store</span><span class="o">.</span><span class="na">listenerManager</span><span class="o">.</span><span class="na">fireFeaturesRemoved</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">autoCommit</span><span class="o">,</span>
                    <span class="n">ReferencedEnvelope</span><span class="o">.</span><span class="na">reference</span><span class="o">(</span><span class="n">origional</span><span class="o">.</span><span class="na">getBounds</span><span class="o">()),</span> <span class="kc">false</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">origional</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">live</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// prevent live and remove from being written out</span>
    <span class="o">}</span>
</pre></div>
</div>
</li>
</ol>
<blockquote>
<div>To implement remove, we will skip over the origional feature (and just won&#8217;t write it out).
Most of the method is devoted to gathering up the information needed to issue
a feature removed event.</div></blockquote>
<ol class="arabic" start="8">
<li><p class="first">Add close() Implementation:</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">writer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&quot;writer already closed&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// write out remaining contents from reader</span>
        <span class="c1">// if applicable</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">reader</span><span class="o">.</span><span class="na">next</span><span class="o">();</span> <span class="c1">// advance</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">echoLine</span><span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">line</span><span class="o">);</span> <span class="c1">// echo unchanged</span>
        <span class="o">}</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">reader</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">read</span><span class="o">.</span><span class="na">delete</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">write</span><span class="o">.</span><span class="na">exists</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">write</span><span class="o">.</span><span class="na">renameTo</span><span class="o">(</span><span class="n">read</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">FileChannel</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="n">read</span><span class="o">).</span><span class="na">getChannel</span><span class="o">();</span>
            <span class="n">FileChannel</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">write</span><span class="o">).</span><span class="na">getChannel</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="kt">long</span> <span class="n">len</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
                <span class="kt">long</span> <span class="n">copied</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="na">transferFrom</span><span class="o">(</span><span class="n">in</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">in</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>

                <span class="k">if</span> <span class="o">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">copied</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&quot;unable to complete write&quot;</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">read</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">write</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">store</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
<p>To implement close() we must remember to write out any remaining features in the DataStore
before closing our new file. To implement this we have performed a small optimization: we
echo the line acquired by the PropertyFeatureReader.</p>
<p>The last thing our FeatureWriter must do is replace the existing File with our new one.</p>
</li>
</ol>
</div>
<div class="section" id="propertyattributewriter">
<h3>PropertyAttributeWriter<a class="headerlink" href="#propertyattributewriter" title="Permalink to this headline">¶</a></h3>
<p>In the previous section we explored the capabilities of our PropertyWriter through actual use;
now we can go ahead and define the class.</p>
<ol class="arabic">
<li><p class="first">Create PropertyAttributeWriter:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.geotools.data.property</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.BufferedWriter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileWriter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.MatchResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.Matcher</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.Pattern</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.geotools.data.AttributeWriter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.data.DataUtilities</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.util.Converters</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.feature.simple.SimpleFeatureType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.feature.type.AttributeDescriptor</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.vividsolutions.jts.geom.Geometry</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Simple AttributeWriter that produces Java properties files.</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * This AttributeWriter is part of the geotools2 DataStore tutorial, and should</span>
<span class="cm"> * be considered a Toy.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * The content produced witll start with the property &quot;_&quot; with the value being</span>
<span class="cm"> * the typeSpec describing the featureType. Thereafter each line will represent</span>
<span class="cm"> * a Features with FeatureID as the property and the attribtues as the value</span>
<span class="cm"> * separated by | characters.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> * </span>
<span class="cm"> * &lt;pre&gt;</span>
<span class="cm"> * &lt;code&gt;</span>
<span class="cm"> * _=id:Integer|name:String|geom:Geometry</span>
<span class="cm"> * fid1=1|Jody|&lt;i&gt;well known text&lt;/i&gt;</span>
<span class="cm"> * fid2=2|Brent|&lt;i&gt;well known text&lt;/i&gt;</span>
<span class="cm"> * fid3=3|Dave|&lt;i&gt;well known text&lt;/i&gt;</span>
<span class="cm"> * &lt;/code&gt;</span>
<span class="cm"> * &lt;/pre&gt;</span>
<span class="cm"> * </span>
<span class="cm"> * @author Jody Garnett</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * @source $URL$</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PropertyAttributeWriter</span> <span class="kd">implements</span> <span class="n">AttributeWriter</span> <span class="o">{</span>
    <span class="n">BufferedWriter</span> <span class="n">writer</span><span class="o">;</span>

    <span class="n">SimpleFeatureType</span> <span class="n">type</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">PropertyAttributeWriter</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">,</span> <span class="n">SimpleFeatureType</span> <span class="n">featureType</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedWriter</span><span class="o">(</span><span class="k">new</span> <span class="n">FileWriter</span><span class="o">(</span><span class="n">file</span><span class="o">));</span>
        <span class="n">type</span> <span class="o">=</span> <span class="n">featureType</span><span class="o">;</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">&quot;_=&quot;</span><span class="o">);</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">DataUtilities</span><span class="o">.</span><span class="na">spec</span><span class="o">(</span><span class="n">type</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getAttributeCount</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">type</span><span class="o">.</span><span class="na">getAttributeCount</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">AttributeDescriptor</span> <span class="nf">getAttributeType</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">ArrayIndexOutOfBoundsException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">type</span><span class="o">.</span><span class="na">getDescriptor</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
<p>A BufferedWriter is created over the provided File, and the provided featureType is used to
implement getAttributeCount() and getAttributeType( index ).</p>
</li>
<li><p class="first">Add hasNext() and next() implementations:</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">next</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">writer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&quot;Writer has been closed&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">newLine</span><span class="o">();</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
</div>
</li>
</ol>
<blockquote>
<div><p>Our FeatureWriter does not provide any content of its own. FeatureWriters that are backed by
JDBC ResultSets or random access file may use hasNext() to indicate that they are streaming
over existing result set.</p>
<p>Our implementation of next() will start a newLine for the feature that is about to be written.</p>
</div></blockquote>
<ol class="arabic" start="3">
<li><p class="first">Add writeFeatureID():</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeFeatureID</span><span class="o">(</span><span class="n">String</span> <span class="n">fid</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">writer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&quot;Writer has been closed&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">fid</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</li>
</ol>
<blockquote>
<div>Our file format is capable of storing FeatureIDs. Many DataStores will need to derive or encode
FeatureID information into their Attributes.</div></blockquote>
<ol class="arabic" start="4">
<li><p class="first">Add write( int index, Object value ):</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="n">Object</span> <span class="n">attribute</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">writer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&quot;Writer has been closed&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">position</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">&quot;=&quot;</span> <span class="o">:</span> <span class="s">&quot;|&quot;</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">attribute</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">&quot;&lt;null&gt;&quot;</span><span class="o">);</span> <span class="c1">// nothing!</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span> <span class="n">attribute</span> <span class="k">instanceof</span> <span class="n">String</span><span class="o">){</span>
            <span class="n">String</span> <span class="n">txt</span> <span class="o">=</span> <span class="n">encodeString</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">attribute</span><span class="o">);</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span> <span class="n">txt</span> <span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">attribute</span> <span class="k">instanceof</span> <span class="n">Geometry</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Geometry</span> <span class="n">geometry</span> <span class="o">=</span> <span class="o">(</span><span class="n">Geometry</span><span class="o">)</span> <span class="n">attribute</span><span class="o">;</span>
            <span class="n">String</span> <span class="n">txt</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="na">toText</span><span class="o">();</span>
            
            <span class="n">txt</span> <span class="o">=</span> <span class="n">encodeString</span><span class="o">(</span> <span class="n">txt</span> <span class="o">);</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span> <span class="n">txt</span> <span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">txt</span> <span class="o">=</span> <span class="n">Converters</span><span class="o">.</span><span class="na">convert</span><span class="o">(</span> <span class="n">attribute</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span> <span class="o">);</span>
            <span class="k">if</span><span class="o">(</span> <span class="n">txt</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">){</span> <span class="c1">// could not convert?</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="n">attribute</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="n">encodeString</span><span class="o">(</span> <span class="n">txt</span> <span class="o">);</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span> <span class="n">txt</span> <span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Used to encode common whitespace characters and | character for safe transport.</span>
<span class="cm">     * </span>
<span class="cm">     * @param txt</span>
<span class="cm">     * @return txt encoded for storage</span>
<span class="cm">     * @see PropertyAttributeReader#decodeString(String)</span>
<span class="cm">     */</span>
    <span class="n">String</span> <span class="nf">encodeString</span><span class="o">(</span> <span class="n">String</span> <span class="n">txt</span> <span class="o">){</span>
        <span class="c1">// encode our escaped characters</span>
        <span class="c1">// txt = txt.replace(&quot;\\&quot;, &quot;\\\\&quot;);</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">&quot;|&quot;</span><span class="o">,</span><span class="s">&quot;\\|&quot;</span><span class="o">);</span>

        <span class="c1">// encode whitespace constants</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">,</span> <span class="s">&quot;\\n&quot;</span><span class="o">);</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">&quot;\r&quot;</span><span class="o">,</span> <span class="s">&quot;\\r&quot;</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">txt</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</li>
</ol>
<blockquote>
<div><p>Our implementation needs to prepend an equals sign before the first Attribute, or a bar for any
other attribute.</p>
<p>We also make sure to encode any newlines in String content, Geometry as wkt, and use the Converters
class to handle any other objects correctly.</p>
</div></blockquote>
<ol class="arabic" start="5">
<li><p class="first">Add close():</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">writer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&quot;Writer has already been closed&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">type</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Finally, to implement our FeatureWriter.close() optimization, we need to implement echoLine():</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">echoLine</span><span class="o">(</span><span class="n">String</span> <span class="n">line</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">writer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&quot;Writer has been closed&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">line</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="part-5-using-propertydatastore-to-write-files">
<h2>Part 5 - Using PropertyDataStore to Write Files<a class="headerlink" href="#part-5-using-propertydatastore-to-write-files" title="Permalink to this headline">¶</a></h2>
<p>In this part we will explore the full capabilities of our completed PropertyDataStore.</p>
<p>Now that we have completed our PropertyDataStore implementation, we can explore the remaining
capabilities of the DataStore API.</p>
<p>PropertyDataStore API for data modification:</p>
<ul class="simple">
<li>PropertyDataStore.createSchema( featureType )</li>
<li>PropertyDataStore.getFeatureWriter( typeName, filter, Transaction )</li>
<li>PropertyDataStore.getFeatureWriter( typeName, Transaction )</li>
<li>PropertyDataStore.getFeatureWriterAppend( typeName, Transaction )</li>
<li>PropertyDataStore.getFeatureSource( typeName )</li>
</ul>
<div class="section" id="id2">
<h3>FeatureSource<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>The DataStore.getFeatureSource( typeName ) method is the gateway to our high level api, as
provided by an instance of FeatureSource, FeatureStore or FeatureLocking.</p>
<p>Now that we have implemented writing operations, the result of this method supports:</p>
<ul class="simple">
<li>FeatureSource: the query operations outlined in DataStore Tutorial 2: Use</li>
<li>FeatureStore: modification and transaction support</li>
<li>FeatureLocking: Interaction with a Feature-based Locking</li>
</ul>
<div class="section" id="featurestore">
<h4>FeatureStore<a class="headerlink" href="#featurestore" title="Permalink to this headline">¶</a></h4>
<p>FeatureStore provides Transaction support and modification operations. FeatureStore is an
extension of FeatureSource. You may check the result of getFeatureSource( typeName ) with the instanceof operator.</p>
<p>Example of FeatureStore use:</p>
<div class="highlight-java"><div class="highlight"><pre>        <span class="n">PropertyDataStore</span> <span class="n">datastore</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PropertyDataStore</span><span class="o">(</span><span class="n">directory</span><span class="o">);</span>
        <span class="n">SimpleFeatureSource</span> <span class="n">featureSource</span> <span class="o">=</span> <span class="n">datastore</span>
                <span class="o">.</span><span class="na">getFeatureSource</span><span class="o">(</span><span class="s">&quot;example&quot;</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!(</span><span class="n">featureSource</span> <span class="k">instanceof</span> <span class="n">SimpleFeatureStore</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&quot;Modification not supported&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">SimpleFeatureStore</span> <span class="n">featureStore</span> <span class="o">=</span> <span class="o">(</span><span class="n">SimpleFeatureStore</span><span class="o">)</span> <span class="n">featureSource</span><span class="o">;</span>
</pre></div>
</div>
<p>FeatureStore defines:</p>
<ul class="simple">
<li>FeatureStore.addFeatures( featureReader)</li>
<li>FeatureStore.removeFeatures( filter )</li>
<li>FeatureStore.modifyFeatures( type, value, filter )</li>
<li>FeatureStore.modifyFeatures( types, values, filter )</li>
<li>FeatureStore.setFeatures( featureReader )</li>
<li>FeatureStore.setTransaction( transaction )</li>
</ul>
<p>Once again, many DataStores are able to provide optimised implementations of these operations.</p>
<p>Transaction Example:</p>
<div class="highlight-java"><div class="highlight"><pre>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Serializable</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Serializable</span><span class="o">&gt;();</span>
        <span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;directory&quot;</span><span class="o">,</span> <span class="n">directory</span><span class="o">);</span>
        <span class="n">DataStore</span> <span class="n">store</span> <span class="o">=</span> <span class="n">DataStoreFinder</span><span class="o">.</span><span class="na">getDataStore</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>

        <span class="n">Transaction</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultTransaction</span><span class="o">(</span><span class="s">&quot;transaction 1&quot;</span><span class="o">);</span>
        <span class="n">Transaction</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultTransaction</span><span class="o">(</span><span class="s">&quot;transactoin 2&quot;</span><span class="o">);</span>

        <span class="n">SimpleFeatureType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">getSchema</span><span class="o">(</span><span class="s">&quot;example&quot;</span><span class="o">);</span>
        <span class="n">SimpleFeatureStore</span> <span class="n">featureStore</span> <span class="o">=</span> <span class="o">(</span><span class="n">SimpleFeatureStore</span><span class="o">)</span> <span class="n">store</span>
                <span class="o">.</span><span class="na">getFeatureSource</span><span class="o">(</span><span class="s">&quot;example&quot;</span><span class="o">);</span>
        <span class="n">SimpleFeatureStore</span> <span class="n">featureStore1</span> <span class="o">=</span> <span class="o">(</span><span class="n">SimpleFeatureStore</span><span class="o">)</span> <span class="n">store</span>
                <span class="o">.</span><span class="na">getFeatureSource</span><span class="o">(</span><span class="s">&quot;example&quot;</span><span class="o">);</span>
        <span class="n">SimpleFeatureStore</span> <span class="n">featureStore2</span> <span class="o">=</span> <span class="o">(</span><span class="n">SimpleFeatureStore</span><span class="o">)</span> <span class="n">store</span>
                <span class="o">.</span><span class="na">getFeatureSource</span><span class="o">(</span><span class="s">&quot;example&quot;</span><span class="o">);</span>

        <span class="n">featureStore1</span><span class="o">.</span><span class="na">setTransaction</span><span class="o">(</span><span class="n">t1</span><span class="o">);</span>
        <span class="n">featureStore2</span><span class="o">.</span><span class="na">setTransaction</span><span class="o">(</span><span class="n">t2</span><span class="o">);</span>
        
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Step 1&quot;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;------&quot;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;start     auto-commit: &quot;</span><span class="o">+</span><span class="n">DataUtilities</span><span class="o">.</span><span class="na">fidSet</span><span class="o">(</span><span class="n">featureStore</span><span class="o">.</span><span class="na">getFeatures</span><span class="o">())</span> <span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;start              t1: &quot;</span><span class="o">+</span><span class="n">DataUtilities</span><span class="o">.</span><span class="na">fidSet</span><span class="o">(</span><span class="n">featureStore1</span><span class="o">.</span><span class="na">getFeatures</span><span class="o">())</span> <span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;start              t2: &quot;</span><span class="o">+</span><span class="n">DataUtilities</span><span class="o">.</span><span class="na">fidSet</span><span class="o">(</span><span class="n">featureStore2</span><span class="o">.</span><span class="na">getFeatures</span><span class="o">())</span> <span class="o">);</span>
        
        <span class="c1">// select feature to remove</span>
        <span class="n">FilterFactory</span> <span class="n">ff</span> <span class="o">=</span> <span class="n">CommonFactoryFinder</span><span class="o">.</span><span class="na">getFilterFactory</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        <span class="n">Filter</span> <span class="n">filter1</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">singleton</span><span class="o">(</span><span class="n">ff</span><span class="o">.</span><span class="na">featureId</span><span class="o">(</span><span class="s">&quot;fid1&quot;</span><span class="o">)));</span>
        <span class="n">featureStore1</span><span class="o">.</span><span class="na">removeFeatures</span><span class="o">(</span><span class="n">filter1</span><span class="o">);</span> <span class="c1">// road1 removes fid1 on t1</span>
        
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Step 2 transaction 1 removes feature &#39;fid1&#39;&quot;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;------&quot;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;t1 remove auto-commit: &quot;</span><span class="o">+</span><span class="n">DataUtilities</span><span class="o">.</span><span class="na">fidSet</span><span class="o">(</span><span class="n">featureStore</span><span class="o">.</span><span class="na">getFeatures</span><span class="o">())</span> <span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;t1 remove          t1: &quot;</span><span class="o">+</span><span class="n">DataUtilities</span><span class="o">.</span><span class="na">fidSet</span><span class="o">(</span><span class="n">featureStore1</span><span class="o">.</span><span class="na">getFeatures</span><span class="o">())</span> <span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;t1 remove          t2: &quot;</span><span class="o">+</span><span class="n">DataUtilities</span><span class="o">.</span><span class="na">fidSet</span><span class="o">(</span><span class="n">featureStore2</span><span class="o">.</span><span class="na">getFeatures</span><span class="o">())</span> <span class="o">);</span>
 
        <span class="c1">// new feature to add!</span>
        <span class="n">SimpleFeature</span> <span class="n">feature</span> <span class="o">=</span> <span class="n">SimpleFeatureBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span>
                <span class="mi">5</span><span class="o">,</span> <span class="s">&quot;chris&quot;</span><span class="o">,</span> <span class="kc">null</span> <span class="o">},</span> <span class="s">&quot;fid5&quot;</span><span class="o">);</span>
        <span class="n">feature</span><span class="o">.</span><span class="na">getUserData</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="n">Hints</span><span class="o">.</span><span class="na">USE_PROVIDED_FID</span><span class="o">,</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">feature</span><span class="o">.</span><span class="na">getUserData</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="n">Hints</span><span class="o">.</span><span class="na">PROVIDED_FID</span><span class="o">,</span> <span class="s">&quot;fid5&quot;</span><span class="o">);</span>
        
        <span class="n">SimpleFeatureCollection</span> <span class="n">collection</span> <span class="o">=</span> <span class="n">DataUtilities</span><span class="o">.</span><span class="na">collection</span><span class="o">(</span><span class="n">feature</span><span class="o">);</span>
        <span class="n">featureStore2</span><span class="o">.</span><span class="na">addFeatures</span><span class="o">(</span><span class="n">collection</span><span class="o">);</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Step 3 transaction 2 adds a new feature &#39;&quot;</span><span class="o">+</span><span class="n">feature</span><span class="o">.</span><span class="na">getID</span><span class="o">()+</span><span class="s">&quot;&#39;&quot;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;------&quot;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;t2 add    auto-commit: &quot;</span><span class="o">+</span><span class="n">DataUtilities</span><span class="o">.</span><span class="na">fidSet</span><span class="o">(</span><span class="n">featureStore</span><span class="o">.</span><span class="na">getFeatures</span><span class="o">())</span> <span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;t2 add             t1: &quot;</span><span class="o">+</span><span class="n">DataUtilities</span><span class="o">.</span><span class="na">fidSet</span><span class="o">(</span><span class="n">featureStore1</span><span class="o">.</span><span class="na">getFeatures</span><span class="o">())</span> <span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;t1 add             t2: &quot;</span><span class="o">+</span><span class="n">DataUtilities</span><span class="o">.</span><span class="na">fidSet</span><span class="o">(</span><span class="n">featureStore2</span><span class="o">.</span><span class="na">getFeatures</span><span class="o">())</span> <span class="o">);</span>

        <span class="c1">// commit transaction one</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
        
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Step 4 transaction 1 commits the removal of feature &#39;fid1&#39;&quot;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;------&quot;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;t1 commit auto-commit: &quot;</span><span class="o">+</span><span class="n">DataUtilities</span><span class="o">.</span><span class="na">fidSet</span><span class="o">(</span><span class="n">featureStore</span><span class="o">.</span><span class="na">getFeatures</span><span class="o">())</span> <span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;t1 commit          t1: &quot;</span><span class="o">+</span><span class="n">DataUtilities</span><span class="o">.</span><span class="na">fidSet</span><span class="o">(</span><span class="n">featureStore1</span><span class="o">.</span><span class="na">getFeatures</span><span class="o">())</span> <span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;t1 commit          t2: &quot;</span><span class="o">+</span><span class="n">DataUtilities</span><span class="o">.</span><span class="na">fidSet</span><span class="o">(</span><span class="n">featureStore2</span><span class="o">.</span><span class="na">getFeatures</span><span class="o">())</span> <span class="o">);</span>

        <span class="c1">// commit transaction two</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Step 5 transaction 2 commits the addition of &#39;&quot;</span><span class="o">+</span><span class="n">feature</span><span class="o">.</span><span class="na">getID</span><span class="o">()+</span><span class="s">&quot;&#39;&quot;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;------&quot;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;t2 commit auto-commit: &quot;</span><span class="o">+</span><span class="n">DataUtilities</span><span class="o">.</span><span class="na">fidSet</span><span class="o">(</span><span class="n">featureStore</span><span class="o">.</span><span class="na">getFeatures</span><span class="o">())</span> <span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;t2 commit          t1: &quot;</span><span class="o">+</span><span class="n">DataUtilities</span><span class="o">.</span><span class="na">fidSet</span><span class="o">(</span><span class="n">featureStore1</span><span class="o">.</span><span class="na">getFeatures</span><span class="o">())</span> <span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;t2 commit          t2: &quot;</span><span class="o">+</span><span class="n">DataUtilities</span><span class="o">.</span><span class="na">fidSet</span><span class="o">(</span><span class="n">featureStore2</span><span class="o">.</span><span class="na">getFeatures</span><span class="o">())</span> <span class="o">);</span>

        <span class="n">t1</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">store</span><span class="o">.</span><span class="na">dispose</span><span class="o">();</span> <span class="c1">// clear out any listeners</span>
</pre></div>
</div>
<p>This produces the following output:</p>
<blockquote>
<div><div class="highlight-text"><div class="highlight"><pre>Step 1
------
start     auto-commit: [fid3, fid4, fid1, fid2]
start              t1: [fid3, fid4, fid1, fid2]
start              t2: [fid3, fid4, fid1, fid2]

Step 2 transaction 1 removes feature &#39;fid1&#39;
------
t1 remove auto-commit: [fid3, fid4, fid1, fid2]
t1 remove          t1: [fid3, fid4, fid2]
t1 remove          t2: [fid3, fid4, fid1, fid2]

Step 3 transaction 2 adds a new feature &#39;fid5&#39;
------
t2 add    auto-commit: [fid3, fid4, fid1, fid2]
t2 add             t1: [fid3, fid4, fid2]
t1 add             t2: [fid3, fid4, fid1, fid2, fid5]

Step 4 transaction 1 commits the removal of feature &#39;fid1&#39;
------
t1 commit auto-commit: [fid3, fid4, fid2]
t1 commit          t1: [fid3, fid4, fid2]
t1 commit          t2: [fid3, fid4, fid2, fid5]

Step 5 transaction 2 commits the addition of &#39;fid5&#39;
------
t2 commit auto-commit: [fid3, fid4, fid2, fid5]
t2 commit          t1: [fid3, fid4, fid2, fid5]
t2 commit          t2: [fid3, fid4, fid2, fid5]
</pre></div>
</div>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Please review the above code example carefully as it is the best explanation
of transaction independence you will find.</p>
<p>Specifically:</p>
<ul class="last">
<li><p class="first">&#8220;auto-commit&#8221; represents the current contents of the file on disk</p>
</li>
<li><p class="first">Notice how the transactions only reflect the changes the user made relative to
the current file contents.</p>
<p>This is shown after t1 commit, where transaction t2 is seeing 4 features (ie the
current file contents plus the one feature that has been added on t2).</p>
</li>
<li><p class="first">This really shows that FeatureSource and FeatureStore are &#8220;views&#8221; into your data.</p>
<ul class="simple">
<li>If you configure two FeatureStores with the same transaction they will act the same.</li>
<li>Transaction is important and represents what you are working on
FeatureStore is not as important and is just used to make working with your data
easier (or more efficient) than direct use of FeatureWriter.</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="featurelocking">
<h4>FeatureLocking<a class="headerlink" href="#featurelocking" title="Permalink to this headline">¶</a></h4>
<p>FeatureLocking is the last extension to our high-level API. It provides support for preventing
modifications to features for the duration of a Transaction, or a period of time.</p>
<p>FeatureLocking defines:</p>
<ul class="simple">
<li>FeatureLocking.setFeatureLock( featureLock )</li>
<li>FeatureLocking.lockFeatures( query ) - lock features specified by query</li>
<li>FeatureLocking.lockFeatures( filter ) - lock according to constraints</li>
<li>FeatureLocking.lockFeatures() - lock all</li>
<li>FeatureLocking.unLockFeatures( query )</li>
<li>FeatureLocking.unLockFeatures( filter )</li>
<li>FeatureLocking.unLockFeatures()</li>
<li>FeatureLocking.releaseLock( string )</li>
<li>FeatureLocking.refreshLock( string )</li>
</ul>
<p>The concept of a FeatureLock matches the description provided in the OGC Web Feature Server
Specification. Locked Features can only be used via Transactions that have been provided with
the correct authorization.</p>
</div>
</div>
<div class="section" id="featurewriter">
<h3>FeatureWriter<a class="headerlink" href="#featurewriter" title="Permalink to this headline">¶</a></h3>
<p>We have a number of FeatureWriters available for different uses; these implementations
are used by the default implementation of AbstractFeatureStore and AbstractFeatureLocking.</p>
<p>These classes serve as a good example of how to use FeatureWriter.</p>
<div class="section" id="featurewriter-filter">
<h4>FeatureWriter Filter<a class="headerlink" href="#featurewriter-filter" title="Permalink to this headline">¶</a></h4>
<p>The DataStore.getFeatureWriter( typeName, filter, transaction ) method
creates a FeatureWriter used to modify features indicated by a constraint.</p>
<p>Example - removing all features:</p>
<div class="highlight-java"><div class="highlight"><pre>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Serializable</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Serializable</span><span class="o">&gt;();</span>
        <span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;directory&quot;</span><span class="o">,</span> <span class="n">directory</span><span class="o">);</span>
        <span class="n">DataStore</span> <span class="n">store</span> <span class="o">=</span> <span class="n">DataStoreFinder</span><span class="o">.</span><span class="na">getDataStore</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>

        <span class="n">Transaction</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultTransaction</span><span class="o">(</span><span class="s">&quot;transaction&quot;</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">FeatureWriter</span><span class="o">&lt;</span><span class="n">SimpleFeatureType</span><span class="o">,</span> <span class="n">SimpleFeature</span><span class="o">&gt;</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">store</span>
                    <span class="o">.</span><span class="na">getFeatureWriter</span><span class="o">(</span><span class="s">&quot;example&quot;</span><span class="o">,</span> <span class="n">Filter</span><span class="o">.</span><span class="na">INCLUDE</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>

            <span class="n">SimpleFeature</span> <span class="n">feature</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">writer</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">feature</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;remove &quot;</span> <span class="o">+</span> <span class="n">feature</span><span class="o">.</span><span class="na">getID</span><span class="o">());</span>
                    <span class="n">writer</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span> <span class="c1">// marking contents for removal</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">writer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;commit &quot;</span> <span class="o">+</span> <span class="n">t</span><span class="o">);</span> <span class="c1">// now the contents are removed</span>
            <span class="n">t</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">eek</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">t</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">t</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">store</span><span class="o">.</span><span class="na">dispose</span><span class="o">();</span>
        <span class="o">}</span>
</pre></div>
</div>
<p>This FeatureWriter does not allow the addition of new content. It can be used for modification and removal only.</p>
<p>DataStores can often provide an optimized implementation.</p>
</div>
<div class="section" id="id3">
<h4>FeatureWriter<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>The DataStore.getFeatureWriter( typeName, transaction )  method creates a general purpose
FeatureWriter. New content may be added after iterating through the
provided content.</p>
<p>Example - completely replace all features:</p>
<div class="highlight-java"><div class="highlight"><pre>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Serializable</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Serializable</span><span class="o">&gt;();</span>
        <span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;directory&quot;</span><span class="o">,</span> <span class="n">directory</span><span class="o">);</span>
        <span class="n">DataStore</span> <span class="n">store</span> <span class="o">=</span> <span class="n">DataStoreFinder</span><span class="o">.</span><span class="na">getDataStore</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>

        <span class="kd">final</span> <span class="n">SimpleFeatureType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">getSchema</span><span class="o">(</span><span class="s">&quot;example&quot;</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">FeatureWriter</span><span class="o">&lt;</span><span class="n">SimpleFeatureType</span><span class="o">,</span> <span class="n">SimpleFeature</span><span class="o">&gt;</span> <span class="n">writer</span><span class="o">;</span>
        <span class="n">SimpleFeature</span> <span class="n">f</span><span class="o">;</span>
        <span class="n">DefaultFeatureCollection</span> <span class="n">collection</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultFeatureCollection</span><span class="o">();</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">SimpleFeatureBuilder</span>
                <span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span> <span class="mi">1</span><span class="o">,</span> <span class="s">&quot;jody&quot;</span> <span class="o">},</span> <span class="s">&quot;fid1&quot;</span><span class="o">);</span>
        <span class="n">collection</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">SimpleFeatureBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span> <span class="mi">2</span><span class="o">,</span> <span class="s">&quot;brent&quot;</span> <span class="o">},</span>
                <span class="s">&quot;fid3&quot;</span><span class="o">);</span>
        <span class="n">collection</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">SimpleFeatureBuilder</span>
                <span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span> <span class="mi">3</span><span class="o">,</span> <span class="s">&quot;dave&quot;</span> <span class="o">},</span> <span class="s">&quot;fid3&quot;</span><span class="o">);</span>
        <span class="n">collection</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">SimpleFeatureBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span> <span class="mi">4</span><span class="o">,</span> <span class="s">&quot;justin&quot;</span> <span class="o">},</span>
                <span class="s">&quot;fid4&quot;</span><span class="o">);</span>
        <span class="n">collection</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>

        <span class="n">writer</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">getFeatureWriter</span><span class="o">(</span><span class="s">&quot;road&quot;</span><span class="o">,</span> <span class="n">Transaction</span><span class="o">.</span><span class="na">AUTO_COMMIT</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// remove all features</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">writer</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">writer</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                <span class="n">writer</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="c1">// copy new features in</span>
            <span class="n">SimpleFeatureIterator</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="na">features</span><span class="o">();</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">SimpleFeature</span> <span class="n">feature</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                <span class="n">SimpleFeature</span> <span class="n">newFeature</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="na">next</span><span class="o">();</span> <span class="c1">// new blank feature</span>
                <span class="n">newFeature</span><span class="o">.</span><span class="na">setAttributes</span><span class="o">(</span><span class="n">feature</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">());</span>
                <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="featurewriter-append">
<h4>FeatureWriter Append<a class="headerlink" href="#featurewriter-append" title="Permalink to this headline">¶</a></h4>
<p>The DataStore.getFeatureWriterAppend( typeName, transaction ) method creates a FeatureWriter
for adding content.</p>
<p>Example - making a copy:</p>
<div class="highlight-java"><div class="highlight"><pre>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Serializable</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Serializable</span><span class="o">&gt;();</span>
        <span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;directory&quot;</span><span class="o">,</span> <span class="n">directory</span><span class="o">);</span>
        <span class="n">DataStore</span> <span class="n">store</span> <span class="o">=</span> <span class="n">DataStoreFinder</span><span class="o">.</span><span class="na">getDataStore</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>

        <span class="n">FeatureReader</span><span class="o">&lt;</span><span class="n">SimpleFeatureType</span><span class="o">,</span><span class="n">SimpleFeature</span><span class="o">&gt;</span> <span class="n">reader</span><span class="o">;</span>
        <span class="n">FeatureWriter</span><span class="o">&lt;</span><span class="n">SimpleFeatureType</span><span class="o">,</span><span class="n">SimpleFeature</span><span class="o">&gt;</span> <span class="n">writer</span><span class="o">;</span>
        <span class="n">SimpleFeature</span> <span class="n">feature</span><span class="o">,</span> <span class="n">newFeature</span><span class="o">;</span>
        
        <span class="n">SimpleFeatureType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">getSchema</span><span class="o">(</span> <span class="s">&quot;example&quot;</span> <span class="o">);</span>
        <span class="n">SimpleFeatureType</span> <span class="n">type2</span> <span class="o">=</span> <span class="n">DataUtilities</span><span class="o">.</span><span class="na">createType</span><span class="o">(</span> <span class="s">&quot;duplicate&quot;</span><span class="o">,</span> <span class="s">&quot;id:Integer,geom:Geometry,name:String&quot;</span> <span class="o">);</span>
        
        <span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">(</span> <span class="n">type</span><span class="o">.</span><span class="na">getTypeName</span><span class="o">(),</span> <span class="n">Filter</span><span class="o">.</span><span class="na">INCLUDE</span> <span class="o">);</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">getFeatureReader</span><span class="o">(</span> <span class="n">query</span><span class="o">,</span> <span class="n">Transaction</span><span class="o">.</span><span class="na">AUTO_COMMIT</span> <span class="o">);</span>
        <span class="n">store</span><span class="o">.</span><span class="na">createSchema</span><span class="o">(</span> <span class="n">type2</span> <span class="o">);</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">getFeatureWriterAppend</span><span class="o">(</span> <span class="s">&quot;duplicate&quot;</span><span class="o">,</span> <span class="n">Transaction</span><span class="o">.</span><span class="na">AUTO_COMMIT</span> <span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">feature</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                <span class="n">newFeature</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                <span class="n">newFeature</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="n">feature</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">));</span>
                <span class="n">newFeature</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">&quot;geom&quot;</span><span class="o">,</span> <span class="n">feature</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">&quot;geom&quot;</span><span class="o">)</span> <span class="o">);</span>
                <span class="n">newFeature</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="n">feature</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">));</span>
                <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">finally</span> <span class="o">{</span>
            <span class="n">reader</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
        
</pre></div>
</div>
<p>DataStores can often provide an optimised implementation of this method.</p>
</div>
</div>
</div>
<div class="section" id="part-6-optimisation-of-propertydatastore">
<h2>Part 6 - Optimisation of PropertyDataStore<a class="headerlink" href="#part-6-optimisation-of-propertydatastore" title="Permalink to this headline">¶</a></h2>
<p>In this part we will explore several optimisation techniques using our PropertyDataStore.</p>
<div class="section" id="low-level-optimisation">
<h3>Low-Level Optimisation<a class="headerlink" href="#low-level-optimisation" title="Permalink to this headline">¶</a></h3>
<p>AbstractDataStore provides a lot of functionality based on the five methods we implemented in the
Tutorials. By examining its implementation we have an opportunity to discuss several issues with
DataStore development. Please keep these issues in mind when applying your own DataStore
optimisations.</p>
<p>In general the &#8220;Gang of Four&#8221; decorator pattern is used to layer functionality around the
raw <strong>FeatureReader</strong> and <strong>FeatureWriters</strong> you provided. This is very similar to the design
of the <strong>java-io</strong> library (where a BufferedInputStream can be wrapped around a raw
FileInputStream).</p>
<p>From AbstractDataStore getFeatureReader( featureType, filter, transaction ):</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Historically Filter.ALL and Filter.NONE were used as placeholder,
as crazy as it sounds, Filter.ALL filters out ALL (accepts none)
Filter.NONE filters out NONE (accepts ALL)/</p>
<p>These two have been renamed in GeoTools 2.3 for the following:</p>
<ul class="last simple">
<li>Filter.ALL has been replaced with Filter.EXCLUDE</li>
<li>Filter.NONE has been replaced with Filter.INCLUDE</li>
</ul>
</div>
<p>Here is an example of how AbstractDataStore applies wrappers around your raw feature reader:</p>
<div class="highlight-python"><div class="highlight"><pre>public  FeatureReader&lt;SimpleFeatureType, SimpleFeature&gt; getFeatureReader(Query query,Transaction transaction) throws IOException {
    Filter filter = query.getFilter();
    String typeName = query.getTypeName();
    String propertyNames[] = query.getPropertyNames();

    ....

    if (filter == Filter.EXCLUDES) {
        return new EmptyFeatureReader(featureType);
    }
    String typeName = featureType.getTypeName();
    FeatureReader reader = getFeatureReader(typeName);
    if (filter != Filter.INCLUDES) {
        reader = new FilteringFeatureReader(reader, filter);
    }
    if (transaction != Transaction.AUTO_COMMIT) {
        Map diff = state(transaction).diff(typeName);
        reader = new DiffFeatureReader(reader, diff);
    }
    if (!featureType.equals(reader.getFeatureType())) {
        reader = new ReTypeFeatureReader(reader, featureType);
    }
    return reader;
}
</pre></div>
</div>
<p>Support classes used:</p>
<ul class="simple">
<li>EmptyFeatureReader represents an empty result (when using Filter.ALL)</li>
<li>FilteringFeatureReader skips over filtered elements using hasNext()</li>
<li>TransactionStateDiff records a difference Map for the Transaction</li>
<li>DiffFeatureReader is used as a wrapper, allowing the Features to be checked for removal, or
modification before being provided to the user. Any additions performed against the
Transaction are also returned.</li>
<li>ReTypeFeatureReader allows on the fly Schema change</li>
</ul>
<p>From AbstractDataStore getFeatureWriter( typeName, filter, transaction):</p>
<div class="highlight-python"><div class="highlight"><pre>public FeatureWriter getFeatureWriter(String typeName, Filter filter,
        Transaction transaction) throws IOException {
    if (filter == Filter.ALL) {
        FeatureType featureType = getSchema(typeName);
        return new EmptyFeatureWriter(featureType);
    }
    FeatureWriter writer;

    if (transaction == Transaction.AUTO_COMMIT) {
        writer = getFeatureWriter(typeName);
    } else {
        writer = state(transaction).writer(typeName);
    }
    if (lockingManager != null) {
        writer = lockingManager.checkedWriter(writer, transaction);
    }
    if (filter != Filter.NONE) {
        writer = new FilteringFeatureWriter(writer, filter);
    }
    return writer;
}
</pre></div>
</div>
<p>Support classes used:</p>
<ul class="simple">
<li>EmptyFeatureWriter represents an empty result</li>
<li>TransactionStateDiff records a difference map for the Transaction, and provides a FeatureWrapper
around a FeatureReader where modifications are stored in the difference Map</li>
<li>FeatureLocking support is provided InProcessLockingManager in the form of a wrapper that will
prevent modification taking place with out correct authorization</li>
<li>FilteringFeatureWriter is used to skip over any Features not meeting the constraints</li>
</ul>
<p>Every helper class we discussed above can be replaced if your external data source supports the
functionality.</p>
<div class="section" id="external-transaction-support">
<h4>External Transaction Support<a class="headerlink" href="#external-transaction-support" title="Permalink to this headline">¶</a></h4>
<p>All JDBC DataStores support the concept of Transactions natively. JDBDataStore supplies an
example of using Transaction.State to store JDBC connection rather than the Difference map
used above.:</p>
<div class="highlight-python"><div class="highlight"><pre>public class JDBCTransactionState implements State {
    private Connection connection;
    public JDBCTransactionState( Connection c) throws IOException{
        connection = c;
    }
    public Connection getConnection(){
        return connection;
    }
    public void commit() throws IOException {
        connection.commit();
    }
    public void rollback() throws IOException {
        connection.rollback();
    }
}
</pre></div>
</div>
<p>For the purpose of PropertyDataStore we could create a Transaction.State class that records a
temporary File name used for a difference file. By externalising differences to a file rather
than Memory we will be able to handle larger data sets; and recover changes in the event of
an application crash.</p>
<p>Another realistic example is making use of Java Enterprise Edition session information allow
&#8220;per user&#8221; edits.</p>
</div>
<div class="section" id="external-locking-support">
<h4>External Locking Support<a class="headerlink" href="#external-locking-support" title="Permalink to this headline">¶</a></h4>
<p>Several DataStores have an environment that can support native locking. By replacing the use
of the InProcessLockingManager we can make use of native Strong Transaction Support.</p>
</div>
<div class="section" id="single-use-feature-writers">
<h4>Single Use Feature Writers<a class="headerlink" href="#single-use-feature-writers" title="Permalink to this headline">¶</a></h4>
<p>We have a total of three distinct uses for FeatureWriters:</p>
<ul>
<li><p class="first">AbstractDataStore.getFeatureWriter( typeName, transaction )</p>
<p>General purpose FeatureWriter</p>
</li>
<li><p class="first">AbstractDataStore.getFeatureWriter( typeName, filter, transaction )</p>
<p>An optimised version that does not create new content can be created.</p>
</li>
<li><p class="first">AbstractDataStore.getFeatureWriterAppend( typeName, transaction)</p>
<p>An optimised version that duplicates the original file, and opens it in append mode can be
created. We can also perform special tricks such as returning a Feature delegate to the user,
which records when it has been modified.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="high-level-optimisation">
<h3>High-Level Optimisation<a class="headerlink" href="#high-level-optimisation" title="Permalink to this headline">¶</a></h3>
<p>DataStore, FeatureSource and FeatureStore provide a few methods specifically set up
for optimisation.</p>
<div class="section" id="datastore-optimisation">
<h4>DataStore Optimisation<a class="headerlink" href="#datastore-optimisation" title="Permalink to this headline">¶</a></h4>
<p>AbstractDataStore leaves open a number of methods for high-level optimisations:</p>
<ul class="simple">
<li>PropertyDataStore.getCount( query )</li>
<li>PropertyDatastore.getBounds( query )</li>
</ul>
<p>These methods are designed to allow you to easily report the contents of information that
is often contained in your file header. Implementing them is optional, and each method
provides a way for you to indicate if the information is unavailable.</p>
<ul class="simple">
<li>PropertyDatastore.getFeatureSource( typeName );</li>
</ul>
<p>By default the implementations returned are based on FeatureReader and FeatureWriter.
Override this method to return your own subclasses that are tuned for your data format.</p>
</div>
<div class="section" id="featurestore-optimisation">
<h4>FeatureStore Optimisation<a class="headerlink" href="#featurestore-optimisation" title="Permalink to this headline">¶</a></h4>
<p>DataStores operating against rich external data sources can often perform high level optimisations.
JDBCDataStores for instance can often construct SQL statements that completely fulfill a request
without making use of FeatureWriters at all.</p>
<p>When performing these queries please remember two things:</p>
<ol class="arabic simple">
<li>Check the lockingManager - If you are not providing your own native locking support, please
check the user&#8217;s authorisation against the the lockingManager</li>
<li>Event Notification - Remember to fire the appropriate notification events when contents change,
Feature Caches will depend on this notification to accurately track the contents of your
DataStore</li>
</ol>
</div>
<div class="section" id="cacheing-and-featurelistener">
<h4>Cacheing and FeatureListener<a class="headerlink" href="#cacheing-and-featurelistener" title="Permalink to this headline">¶</a></h4>
<p>A common optimisation is to trade memory use for speed by use of a cache. In this section we will
present a simple cache for getBounds() and getCount(Query.ALL).</p>
<p>The best place to locate your cache is in your DataStore implementation, you will need to keep
a separate cache for each Transaction by making use of Transaction.State. By implementing a cache
in the DataStore all operations can benefit.</p>
<p>Another popular technique is to locate the cache in an instance of FeatureSource. While the cache
will be duplicated when multiple FeatureStores are in use, it is convenient to locate the cache
next to the high-level operations that can best benefit.</p>
<p>Finally FeatureResults represents a great opportunity to cache results, rather than reissue them
repeatedly.</p>
<p>FeatureListener (and associated FeatureEvents) provides notification of modification which can be
used to keep your cache implementation in sync with the DataStore.</p>
</div>
</div>
<div class="section" id="id4">
<h3>PropertyDataStore<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>We can fill in the following methods for PropertyDataStore:</p>
<ol class="arabic">
<li><p class="first">getCount( Query )</p>
<p>We would like to improve this by recognizing the special case where the user has asked for
the count of all of the features. In this case the number of Features is the same as
the number of lines in the file (minus one for the header information and any comments).</p>
<p>Things to look out for when reviewing the code:</p>
<ul class="simple">
<li>File time stamp used to indicate when we cached the value, this is used to invalidate our
cache if the file is changed at all.</li>
<li>A little bit of care is taken to avoid counting the header, any comment lines,
and multiple lines</li>
</ul>
<p>We can offer a simple optimisation by counting the number of lines in our file,
when the Query requests all features (using Filter.INCLUDE):</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kt">int</span> <span class="n">cacheCount</span><span class="o">;</span>
    <span class="kt">long</span> <span class="n">cacheTimestamp</span><span class="o">;</span>
    <span class="kd">protected</span> <span class="kt">int</span> <span class="nf">getCount</span><span class="o">(</span><span class="n">Query</span> <span class="n">query</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">query</span><span class="o">.</span><span class="na">getFilter</span><span class="o">()</span> <span class="o">==</span> <span class="n">Filter</span><span class="o">.</span><span class="na">INCLUDE</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">typeName</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">getTypeName</span><span class="o">();</span>
            <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">directory</span><span class="o">,</span> <span class="n">typeName</span> <span class="o">+</span> <span class="s">&quot;.properties&quot;</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">cacheCount</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">file</span><span class="o">.</span><span class="na">lastModified</span><span class="o">()</span> <span class="o">==</span> <span class="n">cacheTimestamp</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">cacheCount</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">cacheCount</span> <span class="o">=</span> <span class="n">PropertyDataStore</span><span class="o">.</span><span class="na">countFile</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
            <span class="n">cacheTimestamp</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">lastModified</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">cacheCount</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="c1">// too expensive count the features</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="cm">/** Used to carefully count the lines in the provided properties file */</span>
    <span class="kd">static</span> <span class="kt">int</span> <span class="nf">countFile</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">LineNumberReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">skip</span><span class="o">=</span><span class="mi">1</span><span class="o">;</span> <span class="c1">// header</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LineNumberReader</span><span class="o">(</span><span class="k">new</span> <span class="n">FileReader</span><span class="o">(</span><span class="n">file</span><span class="o">));</span>
            <span class="n">String</span> <span class="n">line</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                <span class="k">if</span><span class="o">(</span> <span class="n">line</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;#&quot;</span><span class="o">)||</span><span class="n">line</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;!&quot;</span><span class="o">)){</span>
                    <span class="n">skip</span><span class="o">++;</span> <span class="c1">// comment</span>
                <span class="o">}</span>
                <span class="k">if</span><span class="o">(</span> <span class="n">line</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&quot;\\&quot;</span><span class="o">)</span> <span class="o">){</span>
                    <span class="n">skip</span><span class="o">++;</span> <span class="c1">// multiline</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">reader</span><span class="o">.</span><span class="na">getLineNumber</span><span class="o">()</span> <span class="o">-</span> <span class="n">skip</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="c1">// could not quickly determine length</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">reader</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">reader</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// we tried</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">getBounds( Query )</p>
<p>Our file format does not offer an easy way to sort out the bounds (spatial file formats
often include this information in the header). As such we won&#8217;t be implementing getBounds()</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kd">protected</span> <span class="n">ReferencedEnvelope</span> <span class="nf">getBounds</span><span class="o">(</span><span class="n">Query</span> <span class="n">query</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// to expensive - calculate by visiting all the features</span>
    <span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">getFeatureSource( typeName )</p>
<p>We will be returning the following classes (which we will create in the next section).</p>
<ul class="simple">
<li>PropertyFeatureSource - if the file is read-only</li>
<li>PropertyFeatureStore - if the file is writable</li>
</ul>
<p>Here is what that looks like:</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kd">public</span> <span class="n">SimpleFeatureSource</span> <span class="nf">getFeatureSource</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">typeName</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span> <span class="k">this</span><span class="o">.</span><span class="na">directory</span><span class="o">,</span> <span class="n">typeName</span><span class="o">+</span><span class="s">&quot;.properties&quot;</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span> <span class="o">!</span><span class="n">file</span><span class="o">.</span><span class="na">exists</span><span class="o">()){</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">FileNotFoundException</span><span class="o">(</span> <span class="n">file</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">()</span> <span class="o">);</span>
        <span class="o">}</span>        
        <span class="k">if</span><span class="o">(</span> <span class="n">file</span><span class="o">.</span><span class="na">canWrite</span><span class="o">()</span> <span class="o">){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">PropertyFeatureStore</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">typeName</span><span class="o">);</span>
            <span class="c1">//return new PropertyFeatureLocking(this, typeName);</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">PropertyFeatureSource</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">typeName</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">//return super.getFeatureSource(typeName);</span>
    <span class="o">}</span>
</pre></div>
</div>
<p>For a writable file we extend AbstractFeatureLocking which supports thread-safe Locking, and
provides the correct hooks into the AbstractDataStore listenerManager.</p>
</li>
</ol>
</div>
<div class="section" id="propertyfeaturesource">
<h3>PropertyFeatureSource<a class="headerlink" href="#propertyfeaturesource" title="Permalink to this headline">¶</a></h3>
<p>To implement a caching example we are going to produce our own implementation of FeatureSource:</p>
<ol class="arabic">
<li><p class="first">Create the file PropertyFeatureSource:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.geotools.data.property</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.geotools.data.AbstractFeatureSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.data.FeatureListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.data.QueryCapabilities</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.factory.Hints</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.geometry.jts.ReferencedEnvelope</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.feature.simple.SimpleFeatureType</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * </span>
<span class="cm"> *</span>
<span class="cm"> * @source $URL$</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PropertyFeatureSource</span> <span class="kd">extends</span> <span class="n">AbstractFeatureSource</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">typeName</span><span class="o">;</span>
    <span class="n">SimpleFeatureType</span> <span class="n">featureType</span><span class="o">;</span>
    <span class="n">PropertyDataStore</span> <span class="n">store</span><span class="o">;</span>
    <span class="kt">long</span> <span class="n">cacheTimestamp</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="n">ReferencedEnvelope</span> <span class="n">cacheBounds</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="n">PropertyFeatureSource</span><span class="o">(</span><span class="n">PropertyDataStore</span> <span class="n">propertyDataStore</span><span class="o">,</span> <span class="n">String</span> <span class="n">typeName</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">store</span> <span class="o">=</span> <span class="n">propertyDataStore</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">typeName</span> <span class="o">=</span> <span class="n">typeName</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">featureType</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">getSchema</span><span class="o">(</span><span class="n">typeName</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">queryCapabilities</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryCapabilities</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isUseProvidedFIDSupported</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="n">hints</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">Hints</span><span class="o">.</span><span class="na">FEATURE_DETACHED</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">PropertyDataStore</span> <span class="nf">getDataStore</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">store</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addFeatureListener</span><span class="o">(</span><span class="n">FeatureListener</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">store</span><span class="o">.</span><span class="na">listenerManager</span><span class="o">.</span><span class="na">addFeatureListener</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">listener</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">removeFeatureListener</span><span class="o">(</span><span class="n">FeatureListener</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">store</span><span class="o">.</span><span class="na">listenerManager</span><span class="o">.</span><span class="na">removeFeatureListener</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">listener</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">SimpleFeatureType</span> <span class="nf">getSchema</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">featureType</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">We are extending AbstractFeatureSource here, as such we not need to implement
FeatureSource.getCount( query ) as the default implementation will call up to
PropertyDataStore.getCount( query ) implemented earlier.</p>
</li>
<li><p class="first">We can however generate the bounds information and cache the result.</p>
<p>Once again we are using a timestamp of the file to notice if the file is changed
on disk.</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kd">public</span> <span class="n">ReferencedEnvelope</span> <span class="nf">getBounds</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">store</span><span class="o">.</span><span class="na">directory</span><span class="o">,</span> <span class="n">typeName</span> <span class="o">+</span> <span class="s">&quot;.properties&quot;</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cacheBounds</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">file</span><span class="o">.</span><span class="na">lastModified</span><span class="o">()</span> <span class="o">==</span> <span class="n">cacheTimestamp</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// we have the cache</span>
            <span class="k">return</span> <span class="n">cacheBounds</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// calculate and store in cache</span>
            <span class="n">cacheBounds</span> <span class="o">=</span> <span class="n">getFeatures</span><span class="o">().</span><span class="na">getBounds</span><span class="o">();</span>
            <span class="n">cacheTimestamp</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">lastModified</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">cacheBounds</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="c1">// bounds are unavailable!</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Earlier we modified PropertyDataStore to create an instance of this class if the file
was read-only.</p>
</li>
</ol>
</div>
<div class="section" id="propertyfeaturestore">
<h3>PropertyFeatureStore<a class="headerlink" href="#propertyfeaturestore" title="Permalink to this headline">¶</a></h3>
<p>We are going to perform a similar set of optimisations to PropertyFeatureStore; with the added
wrinkle of listening to feature events so we can update our cached values in the event
modifications are made.</p>
<ol class="arabic">
<li><p class="first">Create PropertyFeatureStore as follows:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.geotools.data.property</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.geotools.data.AbstractFeatureLocking</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.data.FeatureEvent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.data.FeatureListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.data.Query</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.data.QueryCapabilities</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.data.Transaction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.data.simple.SimpleFeatureCollection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.data.simple.SimpleFeatureIterator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.factory.Hints</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.geotools.geometry.jts.ReferencedEnvelope</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.feature.simple.SimpleFeature</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.feature.simple.SimpleFeatureType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.filter.Filter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.opengis.geometry.BoundingBox</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Implementation used for writeable property files.</span>
<span class="cm"> * Supports limited caching of number of features and bounds.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * @source $URL$</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PropertyFeatureStore</span> <span class="kd">extends</span> <span class="n">AbstractFeatureLocking</span> <span class="o">{</span>

    <span class="n">String</span> <span class="n">typeName</span><span class="o">;</span>
    <span class="n">SimpleFeatureType</span> <span class="n">featureType</span><span class="o">;</span>
    <span class="n">PropertyDataStore</span> <span class="n">store</span><span class="o">;</span>
    
    <span class="kt">long</span> <span class="n">cacheTimestamp</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="n">ReferencedEnvelope</span> <span class="n">cacheBounds</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">cacheCount</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    
    <span class="n">FeatureListener</span> <span class="n">watcher</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FeatureListener</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">changed</span><span class="o">(</span><span class="n">FeatureEvent</span> <span class="n">featureEvent</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">cacheBounds</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">featureEvent</span><span class="o">.</span><span class="na">getType</span><span class="o">()</span> <span class="o">==</span> <span class="n">FeatureEvent</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">ADDED</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">cacheBounds</span><span class="o">.</span><span class="na">expandToInclude</span><span class="o">(</span><span class="n">featureEvent</span><span class="o">.</span><span class="na">getBounds</span><span class="o">());</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">cacheBounds</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">cacheCount</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">};</span>
    
    <span class="n">PropertyFeatureStore</span><span class="o">(</span> <span class="n">PropertyDataStore</span> <span class="n">propertyDataStore</span><span class="o">,</span> <span class="n">String</span> <span class="n">typeName</span> <span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">singleton</span><span class="o">(</span><span class="n">Hints</span><span class="o">.</span><span class="na">FEATURE_DETACHED</span><span class="o">));</span>
        <span class="k">this</span><span class="o">.</span><span class="na">store</span> <span class="o">=</span> <span class="n">propertyDataStore</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">typeName</span> <span class="o">=</span> <span class="n">typeName</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">featureType</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">getSchema</span><span class="o">(</span> <span class="n">typeName</span> <span class="o">);</span>
        <span class="n">store</span><span class="o">.</span><span class="na">listenerManager</span><span class="o">.</span><span class="na">addFeatureListener</span><span class="o">(</span> <span class="k">this</span><span class="o">,</span> <span class="n">watcher</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">queryCapabilities</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryCapabilities</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isUseProvidedFIDSupported</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span>
</pre></div>
</div>
<p>FeatureEvent provides a bounding box which we can use to selectively invalidate cacheBounds</p>
</li>
<li><p class="first">Yes it is a little awkward not being able to smoothly extend PropertyFeatureSource (this
is one of the fixes we have addressed for ContentDataStore covered in the next tutorial).</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kd">public</span> <span class="n">PropertyDataStore</span> <span class="nf">getDataStore</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">store</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addFeatureListener</span><span class="o">(</span><span class="n">FeatureListener</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">store</span><span class="o">.</span><span class="na">listenerManager</span><span class="o">.</span><span class="na">addFeatureListener</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">listener</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">removeFeatureListener</span><span class="o">(</span>
        <span class="n">FeatureListener</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">store</span><span class="o">.</span><span class="na">listenerManager</span><span class="o">.</span><span class="na">removeFeatureListener</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">listener</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">SimpleFeatureType</span> <span class="nf">getSchema</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">featureType</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">This time we can implement getCount( query ) locally; being sure to check both
the filter (includes all features) and the transaction (auto_commit):</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getCount</span><span class="o">(</span><span class="n">Query</span> <span class="n">query</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span> <span class="n">Filter</span><span class="o">.</span><span class="na">INCLUDE</span> <span class="o">==</span> <span class="n">query</span><span class="o">.</span><span class="na">getFilter</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">getTransaction</span><span class="o">()</span> <span class="o">==</span> <span class="n">Transaction</span><span class="o">.</span><span class="na">AUTO_COMMIT</span> <span class="o">){</span>
            <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span> <span class="n">store</span><span class="o">.</span><span class="na">directory</span><span class="o">,</span> <span class="n">typeName</span><span class="o">+</span><span class="s">&quot;.properties&quot;</span> <span class="o">);</span>
            <span class="k">if</span><span class="o">(!(</span><span class="n">cacheCount</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">file</span><span class="o">.</span><span class="na">lastModified</span><span class="o">()</span> <span class="o">==</span> <span class="n">cacheTimestamp</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">cacheCount</span> <span class="o">=</span> <span class="n">PropertyDataStore</span><span class="o">.</span><span class="na">countFile</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
                <span class="n">cacheTimestamp</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">lastModified</span><span class="o">();</span>
            <span class="o">}</span>
            
            <span class="k">if</span><span class="o">(</span><span class="n">query</span><span class="o">.</span><span class="na">getMaxFeatures</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">cacheCount</span><span class="o">,</span> <span class="n">query</span><span class="o">.</span><span class="na">getMaxFeatures</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">cacheCount</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
        <span class="c1">// return super.getCount(query); // super class checks transaction state diff</span>
    <span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">In a similar fashion getBounds( query ) can be generated and cached:</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="kd">public</span> <span class="n">ReferencedEnvelope</span> <span class="nf">getBounds</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span> <span class="n">store</span><span class="o">.</span><span class="na">directory</span><span class="o">,</span> <span class="n">typeName</span><span class="o">+</span><span class="s">&quot;.properties&quot;</span> <span class="o">);</span>                
        <span class="k">if</span><span class="o">(</span> <span class="n">cacheBounds</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">file</span><span class="o">.</span><span class="na">lastModified</span><span class="o">()</span> <span class="o">==</span> <span class="n">cacheTimestamp</span> <span class="o">){</span>            
            <span class="c1">// we have the cache</span>
            <span class="k">return</span> <span class="n">cacheBounds</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// calculate and store in cache                    </span>
            <span class="n">cacheBounds</span> <span class="o">=</span> <span class="n">getBoundsInternal</span><span class="o">(</span><span class="n">Query</span><span class="o">.</span><span class="na">ALL</span><span class="o">);</span>
            <span class="n">cacheTimestamp</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">lastModified</span><span class="o">();</span>            
            <span class="k">return</span> <span class="n">cacheBounds</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>            
        <span class="o">}</span>
        <span class="c1">// bounds are unavailable!</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">We have already modified PropertyDataStore to return an instance of this class
if the file was writable.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="part-7-quality-assurance">
<h2>Part 7 - Quality Assurance<a class="headerlink" href="#part-7-quality-assurance" title="Permalink to this headline">¶</a></h2>
<p>Since this tutorial has been written the gt-property module has been pressed into service as a
supported module in its own right.</p>
<p>References:</p>
<ul class="simple">
<li><a class="reference internal" href="../library/data/property.html"><em>gt-property</em></a> (User Guide)</li>
<li><a class="reference external" href="http://docs.geotools.org/latest/developer/guide/procedures/create.html">http://docs.geotools.org/latest/developer/guide/procedures/create.html</a> (Developers Guide)</li>
<li><a class="reference external" href="http://docs.geotools.org/latest/developer/guide/procedures/supported.html">http://docs.geotools.org/latest/developer/guide/procedures/supported.html</a> (Developers Guide)</li>
</ul>
<p>To get an idea of what kind of &#8220;extra&#8221; is required for a supported module:</p>
<ul class="simple">
<li>Package up as a maven module.</li>
<li>JUnit Test Cases</li>
</ul>
<div class="section" id="multiline">
<h3>Multiline<a class="headerlink" href="#multiline" title="Permalink to this headline">¶</a></h3>
<p>A bug report asking that gt-properties support multi-line string values.</p>
<p>The suggestion was to use the Properties class, which we could not do and still retain our idea
of streaming the content from disk.</p>
<p>The following change was made To PropertyAttributeReader allow for multi-line entries:</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre>    <span class="cm">/**</span>
<span class="cm">     * Check if the file has another line.</span>
<span class="cm">     * </span>
<span class="cm">     * @return &lt;code&gt;true&lt;/code&gt; if the file has another line</span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">next</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">next</span> <span class="o">=</span> <span class="n">readLine</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">next</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="cm">/**</span>
<span class="cm">     * Read the next line of content, paying careful attention to skip comments and for correct</span>
<span class="cm">     * handling of lines that end with escaped line-feeds to span multi lines in the text file.</span>
<span class="cm">     * </span>
<span class="cm">     * @return</span>
<span class="cm">     * @throws IOException</span>
<span class="cm">     */</span>
    <span class="n">String</span> <span class="nf">readLine</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">StringBuilder</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
        <span class="k">while</span><span class="o">(</span> <span class="kc">true</span> <span class="o">){</span>
            <span class="n">String</span> <span class="n">txt</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(</span> <span class="n">txt</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">){</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">// skip comments</span>
            <span class="k">if</span><span class="o">(</span> <span class="n">txt</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;#&quot;</span><span class="o">)</span> <span class="o">||</span> <span class="n">txt</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;!&quot;</span><span class="o">)){</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">// ignore leading white space</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="n">trimLeft</span><span class="o">(</span> <span class="n">txt</span> <span class="o">);</span>
            
            <span class="c1">// handle escaped line feeds used to span multiple lines</span>
            <span class="k">if</span><span class="o">(</span> <span class="n">txt</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&quot;\\&quot;</span><span class="o">)){</span>
                <span class="n">buffer</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">txt</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="n">txt</span><span class="o">.</span><span class="na">length</span><span class="o">()-</span><span class="mi">1</span><span class="o">)</span> <span class="o">);</span>
                <span class="n">buffer</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">);</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="n">buffer</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">txt</span><span class="o">);</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span><span class="o">(</span> <span class="n">buffer</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">){</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// there is no line</span>
        <span class="o">}</span>
        <span class="n">String</span> <span class="n">raw</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">raw</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="cm">/**</span>
<span class="cm">     * Used to decode common whitespace chracters and escaped | characters.</span>
<span class="cm">     * </span>
<span class="cm">     * @param txt Origional raw text as stored</span>
<span class="cm">     * @return decoded text as provided for storage</span>
<span class="cm">     * @see PropertyAttributeWriter#encodeString(String)</span>
<span class="cm">     */</span>
    <span class="n">String</span> <span class="nf">decodeString</span><span class="o">(</span> <span class="n">String</span> <span class="n">txt</span> <span class="o">){</span>
        <span class="c1">// unpack whitespace constants</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span> <span class="s">&quot;\\n&quot;</span><span class="o">,</span> <span class="s">&quot;\n&quot;</span><span class="o">);</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">&quot;\\r&quot;</span><span class="o">,</span> <span class="s">&quot;\r&quot;</span> <span class="o">);</span>

        <span class="c1">// unpack our our escaped characters</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">&quot;\\|&quot;</span><span class="o">,</span> <span class="s">&quot;|&quot;</span> <span class="o">);</span>
        <span class="c1">// txt = txt.replace(&quot;\\\\&quot;, &quot;\\&quot; );</span>
        
        <span class="k">return</span> <span class="n">txt</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="cm">/**</span>
<span class="cm">     * Trim leading white space as described Properties file standard.</span>
<span class="cm">     * @see Properties#load(java.io.Reader)</span>
<span class="cm">     * @param txt</span>
<span class="cm">     * @return txt leading whitespace removed</span>
<span class="cm">     */</span>
    <span class="n">String</span> <span class="nf">trimLeft</span><span class="o">(</span> <span class="n">String</span> <span class="n">txt</span> <span class="o">){</span>
        <span class="c1">// trim</span>
        <span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">WHITESPACE</span><span class="o">:</span> <span class="k">for</span><span class="o">(</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">txt</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">i</span><span class="o">++</span> <span class="o">){</span>
            <span class="kt">char</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="k">if</span><span class="o">(</span> <span class="n">Character</span><span class="o">.</span><span class="na">isWhitespace</span><span class="o">(</span><span class="n">ch</span><span class="o">)){</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
                <span class="k">break</span> <span class="n">WHITESPACE</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">txt</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">start</span><span class="o">);</span>        
    <span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<p>References:</p>
<ul class="simple">
<li><a class="reference external" href="http://download.oracle.com/javase/6/docs/api/java/util/Properties.html#load(java.io.Reader">http://download.oracle.com/javase/6/docs/api/java/util/Properties.html#load(java.io.Reader</a>)</li>
</ul>
</div>
<div class="section" id="info">
<h3>Info<a class="headerlink" href="#info" title="Permalink to this headline">¶</a></h3>
<p>Another reported issue. You can fill in a &#8220;info&#8221; data structure to more accurately describe your
information to the uDig or GeoServer catalog.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre>    <span class="kd">public</span> <span class="n">ServiceInfo</span> <span class="nf">getInfo</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">DefaultServiceInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultServiceInfo</span><span class="o">();</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setDescription</span><span class="o">(</span><span class="s">&quot;Features from Directory &quot;</span> <span class="o">+</span> <span class="n">directory</span><span class="o">);</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setSchema</span><span class="o">(</span><span class="n">FeatureTypes</span><span class="o">.</span><span class="na">DEFAULT_NAMESPACE</span><span class="o">);</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setSource</span><span class="o">(</span><span class="n">directory</span><span class="o">.</span><span class="na">toURI</span><span class="o">());</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">info</span><span class="o">.</span><span class="na">setPublisher</span><span class="o">(</span><span class="k">new</span> <span class="n">URI</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;user.name&quot;</span><span class="o">)));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">URISyntaxException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">info</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <ul id="breadcrumbs">
            <li class="right" style="margin-right: 10px">
              <a href="datastore/index.html" title="ContentDataStore Tutorial"
                 accesskey="N">next</a></li>
            <li class="right" >
              <a href="process.html" title="Process Tutorial"
                 accesskey="P">previous</a> |</li>
        <li><a href="../index.html">GeoTools 13-SNAPSHOT User Guide</a> &raquo;</li>
          <li><a href="index.html" >Tutorials</a> &raquo;</li>
        <li><a href="#">AbstractDataStore Tutorial</a></li>
      </ul>
    </div> 

    <div class="footer" role="contentinfo">
        &copy; Copyright 2014, GeoTools.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3b1.
    </div>
  </body>
</html>