<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Custom JDBC Access for Images &mdash; GeoTools 13-SNAPSHOT User Guide</title>
    
    <link rel="stylesheet" href="../../../_static/geotools.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '13-SNAPSHOT',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="GeoTools 13-SNAPSHOT User Guide" href="../../../index.html" />
    <link rel="up" title="Image Moasic JDBC" href="index.html" />
    <link rel="next" title="Image Moasic JDBC FAQ" href="faq.html" />
    <link rel="prev" title="Image Moasic JDBC Design" href="internal.html" /> 
  </head>
  <body role="document">
    <div class="header">
        <div class="wrap">
            <h1 id="logo"><a href="http://geotools.org">GeoTools</a></h1>
            <h1 id="logo_osgeo"><a href="http://osgeo.org">OSGeo</a></h1>
            <ul id="top-nav">
                <li class="first"><a href="http://docs.geotools.org">Documentation</a></li>
                <li><a href="http://sourceforge.net/projects/geotools/files">Downloads</a></li>
                <li><a href="http://docs.codehaus.org/display/GEOTOOLS/Home">Wiki</a></li>
                <li><a href="http://geotools.org/about.html">About</a></li>
                <li><a href="http://geotoolsnews.blogspot.com">Blog</a></li>
            </ul>
            <!--div id="searchbox">
                <form class="search" action="../../../search.html" method="get">
                    <input id="searchbox-query" type="text" name="q" size="25" value="Search &hellip;" tabindex="3" onblur="if(this.value=='') this.value='Search &hellip;';" onfocus="if(this.value=='Search &hellip;') this.value='';" />
                    <input id="searchbox-submit" type="image" value="Search" src="../../../_static/img/search_icon_green.png" />
                    <input type="hidden" name="check_keywords" value="yes" />
                    <input type="hidden" name="area" value="default" />
                </form>
            </div-->
        </div>
    </div>

    <div class="related">
      <ul id="breadcrumbs">
        <li><a href="../../../index.html">GeoTools 13-SNAPSHOT User Guide</a> &raquo;</li>
          <li><a href="../../index.html" >Library</a> &raquo;</li>
          <li><a href="../index.html" >Coverage</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Image Moasic JDBC</a> &raquo;</li>
        <li><a href="#">Custom JDBC Access for Images</a></li>
      </ul>
    </div> 

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Custom JDBC Access for Images</a><ul>
<li><a class="reference internal" href="#the-concrete-procedure">The concrete procedure</a></li>
<li><a class="reference internal" href="#the-config-file">The Config file</a></li>
<li><a class="reference internal" href="#deployment">Deployment</a></li>
<li><a class="reference internal" href="#java-example">Java Example</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="internal.html"
                        title="previous chapter">Image Moasic JDBC Design</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="faq.html"
                        title="next chapter">Image Moasic JDBC FAQ</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../../_sources/library/coverage/jdbc/customized.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="custom-jdbc-access-for-images">
<h1>Custom JDBC Access for Images<a class="headerlink" href="#custom-jdbc-access-for-images" title="Permalink to this headline">¶</a></h1>
<p>This plugin is an extension to the Image Mosaicing Pyramidal JDBC Plugin. It is targeted to users
having a special database layout for storing their image data or use a special data base extension
concerning raster data.</p>
<ul class="simple">
<li>Credits: Thanks to some users on the mailing list for their inspiration.</li>
<li>Prerequisites<ul>
<li>JDBC Driver jar file in your classpath</li>
<li>An existing database layout (tables,views) holding the raster data.</li>
</ul>
</li>
</ul>
<p>Image Mosaicing Pyramidal JDBC Plugin has an interface called org.geotools.gce.imagemosaic.jdbc.JDBCAccess.
Classes implementing this interface are responsible for the jdbc communication. Additionally, there is an
abstract base class with some default implementations, org.geotools.gce.imagemosaic.jdbc.JDBCAccessCustom.</p>
<p>A customized implementation should subclass this class and implement two methods. The name of this
subclass is a configuration parameter in the xml config file.</p>
<div class="section" id="the-concrete-procedure">
<h2>The concrete procedure<a class="headerlink" href="#the-concrete-procedure" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Create the subclass</p>
<p>The abstract super class has some nice methods, especially</p>
<ul class="simple">
<li>Connection getConnection()</li>
<li>Config getConfig()</li>
<li>CoordinateReferenceSystem getCRS</li>
</ul>
<p>Here is an example:</p>
<div class="highlight-python"><div class="highlight"><pre>package org.mycompany.jdbc;

public class MyJDBCAccessImpl extends JDBCAccessCustom {

    public MyJDBCAccessImpl(Config config) throws IOException {
        super(config);

    }

    @Override
    public void initialize() throws SQLException, IOException {
    }

    @Override
    public void startTileDecoders(Rectangle pixelDimension, GeneralEnvelope requestEnvelope,
            ImageLevelInfo info, LinkedBlockingQueue&lt;TileQueueElement&gt; tileQueue,
            GridCoverageFactory coverageFactory) throws IOException {

    }
}
</pre></div>
</div>
</li>
<li><p class="first">Initialize the meta info</p>
<p>This is done in the method initialize. This method is called only once for each coverage / xml
config file.</p>
<p>The essential part is to create a list of org.geotools.gce.imagemosaic.jdbc.ImageLevelInfo objects.</p>
<p>The info object at index 0 describes the base image, at index 1 is the info for the first pyramid,
and so on. If there are no pyramids, the list has only one info object.</p>
<p>A code template:</p>
<div class="highlight-python"><div class="highlight"><pre>@Override
public void initialize() throws SQLException, IOException {
    Connection con = getConnection();

    // get the extent in world coordinates, must be implemented
    Envelope extent = getExtent(con);

    // get the crs, method inherited from superclass
    CoordinateReferenceSystem crs = getCRS();

    // fetch the pixel resolution for each pyramid level
    // in the correct order
    String stmt = &quot;select RESX,RESY from ... order by level&quot;;
    PreparedStatement ps = con.prepareStatement(stmt);
    ResultSet rs = ps.executeQuery();
    while (rs.next()) {
        ImageLevelInfo li = new ImageLevelInfo();
        getLevelInfos().add(li);
        li.setResX(rs.getDouble(1));
        li.setResY(rs.getDouble(2));
        li.setExtentMinX(extent.getMinX());
        li.setExtentMaxX(extent.getMaxX());
        li.setExtentMinY(extent.getMinY());
        li.setExtentMaxY(extent.getMaxY());
        li.setCrs(crs);
    }
    rs.close();
    ps.close();

}
</pre></div>
</div>
<p>This is a minimal example setting the meta information absolutely needed. ImageLevelInfo has more
properties which can be useful. Another option is to subclass from ImageLevelInfo and add
customized properties.</p>
</li>
<li><p class="first">Fetch raster data</p>
<p>This is done in the method startTileDecoders. There are a lot of parameters, maybe not all
are useful for a custom implementation.</p>
<dl class="docutils">
<dt>Rectangle pixelDimension</dt>
<dd><p class="first last">The requested size in pixel of the result image, perhaps not needed</p>
</dd>
<dt>GeneralEnvelope requestEnvelope</dt>
<dd><p class="first last">The requested size in world coordinates</p>
</dd>
<dt>ImageLevelInfo info</dt>
<dd><p class="first last">The info object of the pyramid to use</p>
</dd>
<dt>LinkedBlockingQueue&lt;TileQueueElement&gt; tileQueue</dt>
<dd><p class="first last">Queue for holding tile queue elements</p>
</dd>
<dt>GridCoverageFactory coverageFactory</dt>
<dd><p class="first last">perhaps not needed</p>
</dd>
</dl>
<p>This method is responsible for</p>
<ol class="arabic simple">
<li>Fetching the tiles for the given level, the area covered may be larger than the area requested
in the requestEnvelope parameter. This is the minimum to implement.</li>
<li>Additionally to 1. , mosiac the the tiles to one image.</li>
<li>Additionally to 2. , crop the image according to the requestEnvelope param</li>
<li>Additionally to 3, use the pixel dimension of the image and the pixelDimension parameter to
rescale the image.</li>
</ol>
<p>The interesting construct is the tile queue and a tile queue element. Before this method is
called, a tile queue is created. Additionally an ImageComposerThread is created an started. This
thread is responsible for creating the result image. Depending on the implementation
possibilities described above, this thread is responsible to do the missing steps.</p>
<p>As an example:</p>
<ul class="simple">
<li>if the custom implementation of startTileDecoders implements step 1 and 2,</li>
<li>the ImageComposerThread will do the missing steps 3 and 4.</li>
</ul>
<p>The primary job of the startTileDecoders method is to fetch the image data as fast as possible,
creating on or more tile queue elements and put these elements into the queue. The
ImageCompoerThread starts working when the first element is in the queue. It stops working when
it reads a special END Element.</p>
<p>A tile queue element for itself has</p>
<ul class="simple">
<li>an optional name</li>
<li>a BufferedImage object</li>
<li>a GeneralEnvelope describing the the tile rectangle in world coordinates</li>
</ul>
<p>A code template:</p>
<div class="highlight-python"><div class="highlight"><pre>@Override
 public void startTileDecoders(Rectangle pixelDimension, GeneralEnvelope requestEnvelope,
         ImageLevelInfo info, LinkedBlockingQueue&lt;TileQueueElement&gt; tileQueue,
         GridCoverageFactory coverageFactory) throws IOException {
     try {
         Connection con = getConnection();

         // getting the index of the level info object
         int level = getLevelInfos().indexOf(info);

         // this example reads exactly one tile
         BufferedImage img = getBufferedImage(level, con);

         GeneralEnvelope genv = new GeneralEnvelope(info.getCrs());
         genv.setRange(0, info.getExtentMinX(), info.getExtentMaxX());
         genv.setRange(1, info.getExtentMinY(), info.getExtentMaxY());
         TileQueueElement tqElem = new TileQueueElement(&quot;oek&quot;,img,genv);;
         tileQueue.add(tqElem);
         con.close();
     } catch (SQLException ex) {
         throw new RuntimeException(ex);
     }
     // IMPORTANT, this must be the last element
     tileQueue.add(TileQueueElement.ENDELEMENT);
 }
</pre></div>
</div>
<p>This is a simple template. A more complex implementation can be found in class JDBCAccessBase.
This implementation fetches tiles, starts decoder threads to utilize full CPU power, waits for
all decoder threads to finish and sends the end element.</p>
<p>HINT: Hurry up to bring your first tile queue element into the queue.</p>
<p>IMPORTANT: This method must be thread safe, do not modify instance vars or implement other
actions causing problems under load.</p>
</li>
</ol>
</div>
<div class="section" id="the-config-file">
<h2>The Config file<a class="headerlink" href="#the-config-file" title="Permalink to this headline">¶</a></h2>
<p>Here is an example config file:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;
&lt;config version=&quot;1.0&quot;&gt;
    &lt;coverageName name=&quot;oek&quot;/&gt;
    &lt;coordsys name=&quot;EPSG:4326&quot;/&gt;
    &lt;!-- interpolation 1 = nearest neighbour, 2 = bipolar, 3 = bicubic --&gt;
    &lt;scaleop  interpolation=&quot;1&quot;/&gt;
    &lt;axisOrder ignore=&quot;false&quot;/&gt;
    &lt;spatialExtension name=&quot;custom&quot;/&gt;
        &lt;jdbcAccessClassName name=&quot;org.mycompany.jdbc.MyJDBCAccessImpl&quot; /&gt;
    &lt;connect&gt;
        &lt;!-- value DBCP or JNDI --&gt;
        &lt;dstype value=&quot;DBCP&quot;/&gt;
&lt;!--        &lt;jndiReferenceName value=&quot;&quot;/&gt;        --&gt;

        &lt;username value=&quot;geotools&quot; /&gt;
        &lt;password value=&quot;geotools&quot; /&gt;

        &lt;jdbcUrl value=&quot;jdbc:oracle:thin:@ux-mc01.ux-home.local:1521:geotools102&quot; /&gt;
        &lt;driverClassName value=&quot;oracle.jdbc.OracleDriver&quot;/&gt;
        &lt;maxActive value=&quot;10&quot;/&gt;
        &lt;maxIdle value=&quot;0&quot;/&gt;
    &lt;/connect&gt;
&lt;/config&gt;
</pre></div>
</div>
<p>Most elements are self explanatory, the detailed documentation is in Image Mosaicing Pyramidal
JDBC Plugin</p>
<ul class="simple">
<li>The name attribute of the &lt;spatialExtension&gt; Element must be custom.</li>
<li>The name attribute of the &lt;jdbcAccessClassName&gt; Element holds the class name of your implementation, org.mycompany.jdbc.MyJDBCAccessImpl in this example.</li>
</ul>
</div>
<div class="section" id="deployment">
<h2>Deployment<a class="headerlink" href="#deployment" title="Permalink to this headline">¶</a></h2>
<p>Package the Java class(es) in a jar file and copy this jar file to your classpath.</p>
</div>
<div class="section" id="java-example">
<h2>Java Example<a class="headerlink" href="#java-example" title="Permalink to this headline">¶</a></h2>
<p>How to use the new coverage? Again, see at the end of Image Mosaicing Pyramidal JDBC Plugin.</p>
<p>Document generated by Confluence on Feb 16, 2011 06:43</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <ul id="breadcrumbs">
            <li class="right" style="margin-right: 10px">
              <a href="faq.html" title="Image Moasic JDBC FAQ"
                 accesskey="N">next</a></li>
            <li class="right" >
              <a href="internal.html" title="Image Moasic JDBC Design"
                 accesskey="P">previous</a> |</li>
        <li><a href="../../../index.html">GeoTools 13-SNAPSHOT User Guide</a> &raquo;</li>
          <li><a href="../../index.html" >Library</a> &raquo;</li>
          <li><a href="../index.html" >Coverage</a> &raquo;</li>
          <li><a href="index.html" >Image Moasic JDBC</a> &raquo;</li>
        <li><a href="#">Custom JDBC Access for Images</a></li>
      </ul>
    </div> 

    <div class="footer" role="contentinfo">
        &copy; Copyright 2014, GeoTools.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3b1.
    </div>
  </body>
</html>